<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ø³ÛŒØ³ØªÙ… Ø§ÛŒØ¬Ø§Ø¯ ÙØ§Ú©ØªÙˆØ± Ø­Ø±ÙÙ‡â€ŒØ§ÛŒ</title>
    <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.0.0/dist/signature_pad.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #2563eb;
            --primary-dark: #1d4ed8;
            --secondary: #7c3aed;
            --danger: #dc2626;
            --warning: #d97706;
            --success: #059669;
            --dark: #1e293b;
            --light: #f8fafc;
            --gray: #64748b;
            --purple: #8b5cf6;
            --teal: #0d9488;
            --orange: #ea580c;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: 'Vazirmatn', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #334155;
            line-height: 1.5;
            overflow-x: hidden;
            font-size: 14px;
        }

        .container {
            max-width: 100%;
            margin: 0 auto;
            background: white;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            box-shadow: 0 0 30px rgba(0, 0, 0, 0.1);
        }

        .top-header {
            background: linear-gradient(135deg, var(--dark), #334155);
            color: white;
            padding: 12px 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: var(--shadow);
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .logo-icon {
            font-size: 1.5em;
        }

        .logo-text {
            font-size: 1em;
            font-weight: 700;
        }

        .header-btn {
            background: rgba(255, 255, 255, 0.15);
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.85em;
            font-weight: 600;
            transition: all 0.2s ease;
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 6px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .header-btn:hover {
            background: rgba(255, 255, 255, 0.25);
            transform: translateY(-1px);
        }

        .main-content {
            flex: 1;
            padding: 16px;
            overflow-y: auto;
            padding-bottom: 30px;
        }

        .form-container {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: var(--shadow);
            margin-bottom: 20px;
            border: 1px solid #e2e8f0;
            position: relative;
            overflow: hidden;
        }

        .form-container::before {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            left: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
        }

        .form-title {
            font-size: 1.2em;
            font-weight: 800;
            margin-bottom: 20px;
            color: var(--dark);
            text-align: center;
            padding-bottom: 12px;
            border-bottom: 2px solid #e2e8f0;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .form-group {
            margin-bottom: 16px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 700;
            color: var(--dark);
            font-size: 0.9em;
        }

        input, select, textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid #cbd5e1;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.2s;
            background: #f8fafc;
            font-family: inherit;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--primary);
            background: white;
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        .btn {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            border: none;
            padding: 14px 20px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 700;
            transition: all 0.3s;
            width: 100%;
            box-shadow: var(--shadow);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin-bottom: 10px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn-purple {
            background: linear-gradient(135deg, var(--purple), #7c3aed);
        }

        .btn-warning {
            background: linear-gradient(135deg, var(--warning), #b45309);
        }

        .btn-danger {
            background: linear-gradient(135deg, var(--danger), #b91c1c);
        }

        .btn-success {
            background: linear-gradient(135deg, var(--success), #047857);
        }

        .add-cost-btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9em;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s;
            font-weight: 600;
        }

        .add-cost-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(37, 99, 235, 0.3);
        }

        .add-cost-btn.danger {
            background: var(--danger);
        }

        .signature-pad {
            border: 1px solid #cbd5e1;
            border-radius: 8px;
            background: white;
            margin-bottom: 15px;
            height: 150px;
            width: 100%;
            touch-action: none;
        }

        .invoice-preview {
            background: white;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            padding: 20px;
            margin-top: 20px;
            box-shadow: var(--shadow);
        }

        .invoice-header {
            text-align: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--primary);
        }

        .invoice-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }

        .invoice-items {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
            font-size: 0.9em;
        }

        .invoice-items th, .invoice-items td {
            border: 1px solid #e2e8f0;
            padding: 10px;
            text-align: center;
        }

        .invoice-items th {
            background: #f1f5f9;
            font-weight: 700;
            color: var(--dark);
        }

        .invoice-total {
            text-align: left;
            font-weight: 800;
            font-size: 1.1em;
            margin-top: 15px;
        }

        .invoice-signatures {
            display: flex;
            justify-content: space-between;
            margin-top: 40px;
        }

        .signature-box {
            text-align: center;
            width: 45%;
        }

        .signature-line {
            border-top: 1px solid #475569;
            margin-top: 50px;
            padding-top: 8px;
        }

        .success-message {
            background: linear-gradient(135deg, var(--success), #10b981);
            color: white;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            margin: 15px 0;
            font-weight: 700;
            box-shadow: 0 4px 12px rgba(5, 150, 105, 0.4);
            animation: slideIn 0.5s ease-out;
            font-size: 0.9em;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .info-message {
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
            color: white;
            padding: 18px;
            border-radius: 12px;
            margin: 15px 0;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .info-title {
            font-size: 1.1em;
            font-weight: 800;
            margin-bottom: 10px;
        }

        .info-content {
            font-size: 0.9em;
            line-height: 1.6;
            opacity: 0.95;
        }

        .tax-calculations {
            background: #f1f5f9;
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            border-right: 3px solid var(--primary);
        }

        .tax-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 0.9em;
            padding: 5px 0;
        }

        .invoice-item-row {
            margin-bottom: 12px;
            padding: 12px;
            background: #f8fafc;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
        }

        .history-container {
            max-height: 400px;
            overflow-y: auto;
            margin-top: 15px;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 10px;
            background: #f8fafc;
        }

        .history-item {
            padding: 12px;
            background: white;
            border-radius: 8px;
            margin-bottom: 10px;
            border: 1px solid #e2e8f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.2s;
        }

        .history-item:hover {
            border-color: var(--primary);
            box-shadow: 0 2px 6px rgba(37, 99, 235, 0.1);
        }

        .history-info {
            flex: 1;
        }

        .history-date {
            font-size: 0.85em;
            color: var(--gray);
            margin-top: 5px;
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            right: 0;
            left: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            padding: 20px;
        }

        .modal {
            background: white;
            border-radius: 16px;
            width: 100%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: var(--shadow-lg);
            animation: modalSlideIn 0.3s ease-out;
        }

        @keyframes modalSlideIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .modal-header {
            padding: 20px;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-body {
            padding: 20px;
        }

        .modal-footer {
            padding: 20px;
            border-top: 1px solid #e2e8f0;
            display: flex;
            gap: 10px;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 1.5em;
            cursor: pointer;
            color: var(--gray);
            padding: 5px;
        }

        .email-preview {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
            max-height: 200px;
            overflow-y: auto;
            font-size: 0.9em;
            line-height: 1.6;
        }

        @media (min-width: 768px) {
            .container {
                max-width: 800px;
                margin: 20px auto;
                min-height: calc(100vh - 40px);
                border-radius: 20px;
                overflow: hidden;
            }
            
            .btn {
                font-size: 15px;
                padding: 16px 24px;
            }
        }

        @media (max-width: 480px) {
            .main-content {
                padding: 12px;
            }
            
            .form-container {
                padding: 16px;
            }
            
            .invoice-details {
                grid-template-columns: 1fr;
                gap: 12px;
            }
            
            .invoice-signatures {
                flex-direction: column;
                gap: 30px;
            }
            
            .signature-box {
                width: 100%;
            }
            
            .btn {
                padding: 16px;
            }
            
            .invoice-items {
                font-size: 0.8em;
            }
            
            .invoice-items th, .invoice-items td {
                padding: 6px;
            }
        }

        @media print {
            body {
                margin: 0;
                padding: 0;
                font-size: 12px;
                line-height: 1.3;
            }
            
            .no-print {
                display: none !important;
            }
            
            .invoice-preview {
                box-shadow: none;
                border: 1px solid #000;
                width: 100%;
                margin: 0;
                padding: 15px;
                page-break-inside: avoid;
            }
            
            .container {
                max-width: 100%;
                margin: 0;
                border-radius: 0;
                box-shadow: none;
                min-height: auto;
            }
            
            .invoice-items {
                font-size: 10px;
                width: 100%;
            }
            
            .invoice-items th, .invoice-items td {
                padding: 4px;
                border: 1px solid #000;
            }
            
            .tax-calculations {
                border: 1px solid #000;
                background: #fff !important;
                color: #000 !important;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }
            
            .tax-row {
                margin-bottom: 4px;
                font-size: 10px;
            }
            
            .invoice-header h2 {
                font-size: 16px;
                margin-bottom: 5px;
            }
            
            .invoice-header p {
                font-size: 10px;
                margin: 2px 0;
            }
            
            .invoice-details {
                font-size: 10px;
            }
            
            .invoice-details h4 {
                font-size: 11px;
                margin-bottom: 3px;
            }
            
            .invoice-details p {
                margin: 1px 0;
                font-size: 9px;
            }
            
            .invoice-signatures {
                margin-top: 20px;
            }
            
            .signature-line {
                margin-top: 30px;
            }
            
            @page {
                size: landscape;
                margin: 10mm;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="top-header">
            <div class="logo">
                <div class="logo-icon">ğŸ§¾</div>
                <div class="logo-text">Ø³ÛŒØ³ØªÙ… ÙØ§Ú©ØªÙˆØ±Ø³Ø§Ø² Ø­Ø±ÙÙ‡â€ŒØ§ÛŒ</div>
            </div>
            <div style="display: flex; gap: 8px;">
                <button class="header-btn" onclick="showHistory()">
                    <span>ğŸ“‹</span> ØªØ§Ø±ÛŒØ®Ú†Ù‡
                </button>
                <a href="index.html" class="header-btn">ğŸ”™ Ø¨Ø§Ø²Ú¯Ø´Øª</a>
            </div>
        </div>

        <div class="main-content">
            <div class="form-container">
                <h2 class="form-title"><i class="fas fa-file-invoice"></i> Ø§ÛŒØ¬Ø§Ø¯ ÙØ§Ú©ØªÙˆØ± Ø¬Ø¯ÛŒØ¯</h2>
                
                <div class="form-group">
                    <label for="invoice-type"><i class="fas fa-tag"></i> Ù†ÙˆØ¹ ÙØ§Ú©ØªÙˆØ±:</label>
                    <select id="invoice-type">
                        <option value="sale">ÙØ±ÙˆØ´</option>
                        <option value="purchase">Ø®Ø±ÛŒØ¯</option>
                        <option value="proforma">Ù¾ÛŒØ´â€ŒÙØ§Ú©ØªÙˆØ±</option>
                        <option value="return">Ø¨Ø±Ú¯Ø´Øª Ø§Ø² ÙØ±ÙˆØ´</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="invoice-number"><i class="fas fa-hashtag"></i> Ø´Ù…Ø§Ø±Ù‡ ÙØ§Ú©ØªÙˆØ±:</label>
                    <input type="text" id="invoice-number" placeholder="Ø´Ù…Ø§Ø±Ù‡ ÙØ§Ú©ØªÙˆØ± (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)" value="FA-1403-001">
                </div>

                <div class="form-group">
                    <label for="invoice-date"><i class="fas fa-calendar"></i> ØªØ§Ø±ÛŒØ® ÙØ§Ú©ØªÙˆØ±:</label>
                    <input type="date" id="invoice-date">
                </div>

                <div class="form-group">
                    <label for="invoice-due-date"><i class="fas fa-calendar-check"></i> ØªØ§Ø±ÛŒØ® Ø³Ø±Ø±Ø³ÛŒØ¯:</label>
                    <input type="date" id="invoice-due-date">
                </div>

                <div class="form-group">
                    <label for="invoice-seller"><i class="fas fa-user-tie"></i> ÙØ±ÙˆØ´Ù†Ø¯Ù‡:</label>
                    <input type="text" id="invoice-seller" placeholder="Ù†Ø§Ù… ÙØ±ÙˆØ´Ù†Ø¯Ù‡ / Ø´Ø±Ú©Øª" value="Ø´Ø±Ú©Øª Ù†Ù…ÙˆÙ†Ù‡ ØªØ¬Ø§Ø±Øª">
                </div>

                <div class="form-group">
                    <label for="seller-tax-id"><i class="fas fa-id-card"></i> Ø´Ù†Ø§Ø³Ù‡ Ù…Ù„ÛŒ/Ú©Ø¯ Ø§Ù‚ØªØµØ§Ø¯ÛŒ ÙØ±ÙˆØ´Ù†Ø¯Ù‡:</label>
                    <input type="text" id="seller-tax-id" placeholder="Ú©Ø¯ Ø§Ù‚ØªØµØ§Ø¯ÛŒ ÙØ±ÙˆØ´Ù†Ø¯Ù‡" value="12345678901">
                </div>

                <div class="form-group">
                    <label for="seller-address"><i class="fas fa-map-marker-alt"></i> Ø¢Ø¯Ø±Ø³ ÙØ±ÙˆØ´Ù†Ø¯Ù‡:</label>
                    <textarea id="seller-address" rows="2" placeholder="Ø¢Ø¯Ø±Ø³ Ú©Ø§Ù…Ù„ ÙØ±ÙˆØ´Ù†Ø¯Ù‡">ØªÙ‡Ø±Ø§Ù†ØŒ Ø®ÛŒØ§Ø¨Ø§Ù† Ù†Ù…ÙˆÙ†Ù‡ØŒ Ù¾Ù„Ø§Ú© Û±Û²Û³</textarea>
                </div>

                <div class="form-group">
                    <label for="seller-phone"><i class="fas fa-phone"></i> ØªÙ„ÙÙ† ÙØ±ÙˆØ´Ù†Ø¯Ù‡:</label>
                    <input type="text" id="seller-phone" placeholder="Ø´Ù…Ø§Ø±Ù‡ ØªÙ…Ø§Ø³ ÙØ±ÙˆØ´Ù†Ø¯Ù‡" value="021-12345678">
                </div>

                <div class="form-group">
                    <label for="invoice-buyer"><i class="fas fa-user"></i> Ø®Ø±ÛŒØ¯Ø§Ø±:</label>
                    <input type="text" id="invoice-buyer" placeholder="Ù†Ø§Ù… Ø®Ø±ÛŒØ¯Ø§Ø± / Ø´Ø±Ú©Øª" value="Ø´Ø±Ú©Øª Ú©Ø§Ù„Ø§ÛŒ Ø¨Ø±ØªØ±">
                </div>

                <div class="form-group">
                    <label for="buyer-tax-id"><i class="fas fa-id-card"></i> Ø´Ù†Ø§Ø³Ù‡ Ù…Ù„ÛŒ/Ú©Ø¯ Ø§Ù‚ØªØµØ§Ø¯ÛŒ Ø®Ø±ÛŒØ¯Ø§Ø±:</label>
                    <input type="text" id="buyer-tax-id" placeholder="Ú©Ø¯ Ø§Ù‚ØªØµØ§Ø¯ÛŒ Ø®Ø±ÛŒØ¯Ø§Ø±" value="98765432109">
                </div>

                <div class="form-group">
                    <label for="buyer-address"><i class="fas fa-map-marker-alt"></i> Ø¢Ø¯Ø±Ø³ Ø®Ø±ÛŒØ¯Ø§Ø±:</label>
                    <textarea id="buyer-address" rows="2" placeholder="Ø¢Ø¯Ø±Ø³ Ú©Ø§Ù…Ù„ Ø®Ø±ÛŒØ¯Ø§Ø±">Ø§ØµÙÙ‡Ø§Ù†ØŒ Ø®ÛŒØ§Ø¨Ø§Ù† Ù…Ø±Ú©Ø²ÛŒØŒ Ù¾Ù„Ø§Ú© Û´ÛµÛ¶</textarea>
                </div>

                <h3 style="margin: 25px 0 15px; color: var(--dark); display: flex; align-items: center; gap: 10px;">
                    <i class="fas fa-shopping-cart"></i> Ø§Ù‚Ù„Ø§Ù… ÙØ§Ú©ØªÙˆØ±
                </h3>
                
                <div id="invoice-items">
                    <div class="invoice-item-row">
                        <div style="display: grid; grid-template-columns: 2fr 1fr 1fr 1fr auto; gap: 10px; margin-bottom: 10px; align-items: center;">
                            <input type="text" placeholder="Ù†Ø§Ù… Ú©Ø§Ù„Ø§ / Ø®Ø¯Ù…Øª" class="item-name" value="Ù„Ù¾â€ŒØªØ§Ù¾ ØªØ¬Ø§Ø±ÛŒ">
                            <input type="number" placeholder="ØªØ¹Ø¯Ø§Ø¯" class="item-quantity" value="2" min="1">
                            <input type="number" placeholder="Ù‚ÛŒÙ…Øª ÙˆØ§Ø­Ø¯" class="item-price" value="25000000">
                            <input type="number" placeholder="ØªØ®ÙÛŒÙ %" class="item-discount" value="5" min="0" max="100">
                            <button type="button" class="add-cost-btn danger" onclick="removeInvoiceItem(this)">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <textarea class="item-description" placeholder="ØªÙˆØ¶ÛŒØ­Ø§Øª Ú©Ø§Ù„Ø§ (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)" rows="2" style="width: 100%; margin-top: 8px; font-size: 0.9em;">Ù„Ù¾â€ŒØªØ§Ù¾ Û±Ûµ Ø§ÛŒÙ†Ú†ÛŒØŒ Core i7ØŒ 16GB RAM</textarea>
                    </div>
                </div>

                <button type="button" class="add-cost-btn" onclick="addInvoiceItem()" style="margin-bottom: 20px;">
                    <i class="fas fa-plus"></i> Ø§ÙØ²ÙˆØ¯Ù† Ú©Ø§Ù„Ø§ÛŒ Ø¬Ø¯ÛŒØ¯
                </button>

                <div class="form-group">
                    <label for="payment-terms"><i class="fas fa-credit-card"></i> Ø´Ø±Ø§ÛŒØ· Ù¾Ø±Ø¯Ø§Ø®Øª:</label>
                    <select id="payment-terms">
                        <option value="cash">Ù†Ù‚Ø¯ÛŒ</option>
                        <option value="check">Ú†Ú©</option>
                        <option value="installment">Ø§Ù‚Ø³Ø§Ø·</option>
                        <option value="transfer">Ú©Ø§Ø±Øª Ø¨Ù‡ Ú©Ø§Ø±Øª</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="invoice-notes"><i class="fas fa-sticky-note"></i> ØªÙˆØ¶ÛŒØ­Ø§Øª Ùˆ Ø´Ø±Ø§ÛŒØ·:</label>
                    <textarea id="invoice-notes" rows="3" placeholder="ØªÙˆØ¶ÛŒØ­Ø§Øª Ø§Ø¶Ø§ÙÛŒØŒ Ø´Ø±Ø§ÛŒØ· Ú¯Ø§Ø±Ø§Ù†ØªÛŒØŒ Ù†Ø­ÙˆÙ‡ ØªØ­ÙˆÛŒÙ„ Ùˆ ...">Ú©Ø§Ù„Ø§Ù‡Ø§ Ø¸Ø±Ù Û³ Ø±ÙˆØ² Ú©Ø§Ø±ÛŒ Ø¢Ù…Ø§Ø¯Ù‡ ØªØ­ÙˆÛŒÙ„ Ù…ÛŒâ€ŒØ¨Ø§Ø´Ø¯. Ú¯Ø§Ø±Ø§Ù†ØªÛŒ Û±Û¸ Ù…Ø§Ù‡Ù‡</textarea>
                </div>

                <h3 style="margin: 25px 0 15px; color: var(--dark); display: flex; align-items: center; gap: 10px;">
                    <i class="fas fa-signature"></i> Ø§Ù…Ø¶Ø§Ù‡Ø§
                </h3>
                
                <div class="signature-pad-container">
                    <label>Ø§Ù…Ø¶Ø§ÛŒ ÙØ±ÙˆØ´Ù†Ø¯Ù‡:</label>
                    <canvas class="signature-pad" id="seller-signature-pad"></canvas>
                    <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                        <button type="button" class="add-cost-btn danger" onclick="clearSellerSignature()">
                            <i class="fas fa-trash"></i> Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† Ø§Ù…Ø¶Ø§
                        </button>
                        <button type="button" class="add-cost-btn" onclick="loadSampleSignature()">
                            <i class="fas fa-signature"></i> Ø§Ù…Ø¶Ø§ÛŒ Ù†Ù…ÙˆÙ†Ù‡
                        </button>
                    </div>
                </div>

                <div class="form-group">
                    <label for="seller-stamp"><i class="fas fa-stamp"></i> Ù…Ù‡Ø± ÙØ±ÙˆØ´Ù†Ø¯Ù‡ (URL ØªØµÙˆÛŒØ±):</label>
                    <input type="text" id="seller-stamp" placeholder="Ø¢Ø¯Ø±Ø³ ØªØµÙˆÛŒØ± Ù…Ù‡Ø± Ø´Ø±Ú©Øª (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)">
                </div>

                <button class="btn btn-purple" onclick="generateInvoice()">
                    <i class="fas fa-file-invoice"></i> Ø§ÛŒØ¬Ø§Ø¯ Ùˆ Ù¾ÛŒØ´â€ŒÙ†Ù…Ø§ÛŒØ´ ÙØ§Ú©ØªÙˆØ±
                </button>

                <button class="btn btn-warning no-print" onclick="saveInvoiceTemplate()">
                    <i class="fas fa-save"></i> Ø°Ø®ÛŒØ±Ù‡ Ù‚Ø§Ù„Ø¨ ÙØ§Ú©ØªÙˆØ±
                </button>

                <button class="btn btn-danger no-print" onclick="clearInvoiceForm()">
                    <i class="fas fa-trash"></i> Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† ÙØ±Ù…
                </button>
            </div>

            <div class="invoice-preview no-print" id="invoice-preview" style="display: none;">
                <!-- Ù¾ÛŒØ´â€ŒÙ†Ù…Ø§ÛŒØ´ ÙØ§Ú©ØªÙˆØ± Ø¯Ø± Ø§ÛŒÙ†Ø¬Ø§ Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯ -->
            </div>

            <div class="form-container no-print" id="invoice-actions" style="display: none;">
                <h2 class="form-title"><i class="fas fa-tasks"></i> Ø§Ù‚Ø¯Ø§Ù…Ø§Øª ÙØ§Ú©ØªÙˆØ±</h2>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                    <button class="btn" onclick="downloadInvoiceAsPDF()">
                        <i class="fas fa-download"></i> Ø¯Ø§Ù†Ù„ÙˆØ¯ PDF
                    </button>
                    <button class="btn btn-purple" onclick="printInvoice()">
                        <i class="fas fa-print"></i> Ú†Ø§Ù¾ ÙØ§Ú©ØªÙˆØ±
                    </button>
                    <button class="btn btn-warning" onclick="sendInvoiceByEmail()">
                        <i class="fas fa-envelope"></i> Ø§Ø±Ø³Ø§Ù„ Ø§ÛŒÙ…ÛŒÙ„
                    </button>
                    <button class="btn btn-success" onclick="saveInvoiceToHistory()">
                        <i class="fas fa-history"></i> Ø°Ø®ÛŒØ±Ù‡ Ø¯Ø± ØªØ§Ø±ÛŒØ®Ú†Ù‡
                    </button>
                </div>
            </div>

            <div class="form-container no-print">
                <h2 class="form-title"><i class="fas fa-info-circle"></i> Ø±Ø§Ù‡Ù†Ù…Ø§ÛŒ Ø§ÛŒØ¬Ø§Ø¯ ÙØ§Ú©ØªÙˆØ±</h2>
                <div class="info-message">
                    <div class="info-title">Ù†Ú©Ø§Øª Ù…Ù‡Ù… Ø¨Ø±Ø§ÛŒ ÙØ§Ú©ØªÙˆØ±Ù‡Ø§ÛŒ Ù…Ø¹ØªØ¨Ø±</div>
                    <div class="info-content">
                        â€¢ Ø´Ù…Ø§Ø±Ù‡ ÙØ§Ú©ØªÙˆØ± Ø¨Ø§ÛŒØ¯ Ù…Ù†Ø­ØµØ± Ø¨Ù‡ ÙØ±Ø¯ Ø¨Ø§Ø´Ø¯<br>
                        â€¢ Ø§Ø·Ù„Ø§Ø¹Ø§Øª ÙØ±ÙˆØ´Ù†Ø¯Ù‡ Ùˆ Ø®Ø±ÛŒØ¯Ø§Ø± Ø¨Ø§ÛŒØ¯ Ú©Ø§Ù…Ù„ Ø¨Ø§Ø´Ø¯<br>
                        â€¢ Ø¨Ø±Ø§ÛŒ ÙØ§Ú©ØªÙˆØ±Ù‡Ø§ÛŒ Ø¨Ø§Ù„Ø§ÛŒ Û±Û° Ù…ÛŒÙ„ÛŒÙˆÙ† Ø§Ù…Ø¶Ø§ Ø§Ù„Ø²Ø§Ù…ÛŒ Ø§Ø³Øª<br>
                        â€¢ ÙØ§Ú©ØªÙˆØ±Ù‡Ø§ Ø¨Ù‡ Ù…Ø¯Øª Û±Û° Ø³Ø§Ù„ Ø¨Ø§ÛŒØ¯ Ø¢Ø±Ø´ÛŒÙˆ Ø´ÙˆÙ†Ø¯
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Ø¨Ø±Ø§ÛŒ ØªØ§Ø±ÛŒØ®Ú†Ù‡ -->
    <div class="modal-overlay" id="history-modal" style="display: none;">
        <div class="modal">
            <div class="modal-header">
                <h2 style="margin: 0; display: flex; align-items: center; gap: 10px;">
                    <i class="fas fa-history"></i> ØªØ§Ø±ÛŒØ®Ú†Ù‡ ÙØ§Ú©ØªÙˆØ±Ù‡Ø§
                </h2>
                <button class="close-btn" onclick="closeModal('history-modal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="history-container" id="history-list">
                    <!-- Ù„ÛŒØ³Øª ÙØ§Ú©ØªÙˆØ±Ù‡Ø§ÛŒ ØªØ§Ø±ÛŒØ®Ú†Ù‡ -->
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-danger" onclick="clearHistory()">
                    <i class="fas fa-trash"></i> Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† ØªØ§Ø±ÛŒØ®Ú†Ù‡
                </button>
                <button class="btn" onclick="closeModal('history-modal')">
                    <i class="fas fa-times"></i> Ø¨Ø³ØªÙ†
                </button>
            </div>
        </div>
    </div>

    <!-- Modal Ø¨Ø±Ø§ÛŒ Ø§Ø±Ø³Ø§Ù„ Ø§ÛŒÙ…ÛŒÙ„ -->
    <div class="modal-overlay" id="email-modal" style="display: none;">
        <div class="modal">
            <div class="modal-header">
                <h2 style="margin: 0; display: flex; align-items: center; gap: 10px;">
                    <i class="fas fa-envelope"></i> Ø§Ø±Ø³Ø§Ù„ ÙØ§Ú©ØªÙˆØ± Ø§Ø² Ø·Ø±ÛŒÙ‚ Ø§ÛŒÙ…ÛŒÙ„
                </h2>
                <button class="close-btn" onclick="closeModal('email-modal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="email-recipient"><i class="fas fa-user"></i> Ø¯Ø±ÛŒØ§ÙØª Ú©Ù†Ù†Ø¯Ù‡ (Ø§ÛŒÙ…ÛŒÙ„):</label>
                    <input type="email" id="email-recipient" placeholder="Ø§ÛŒÙ…ÛŒÙ„ Ø¯Ø±ÛŒØ§ÙØª Ú©Ù†Ù†Ø¯Ù‡ (Ù…Ø«Ø§Ù„: info@example.com)" multiple>
                    <small style="display: block; margin-top: 5px; color: var(--gray);">Ø¨Ø±Ø§ÛŒ Ø§Ø±Ø³Ø§Ù„ Ø¨Ù‡ Ú†Ù†Ø¯ Ù†ÙØ±ØŒ Ø§ÛŒÙ…ÛŒÙ„â€ŒÙ‡Ø§ Ø±Ø§ Ø¨Ø§ Ú©Ø§Ù…Ø§ Ø¬Ø¯Ø§ Ú©Ù†ÛŒØ¯</small>
                </div>
                
                <div class="form-group">
                    <label for="email-subject"><i class="fas fa-tag"></i> Ù…ÙˆØ¶ÙˆØ¹ Ø§ÛŒÙ…ÛŒÙ„:</label>
                    <input type="text" id="email-subject" placeholder="Ù…ÙˆØ¶ÙˆØ¹ Ø§ÛŒÙ…ÛŒÙ„" value="ÙØ§Ú©ØªÙˆØ± Ø¬Ø¯ÛŒØ¯ - ">
                </div>
                
                <div class="form-group">
                    <label><i class="fas fa-eye"></i> Ù¾ÛŒØ´â€ŒÙ†Ù…Ø§ÛŒØ´ Ø§ÛŒÙ…ÛŒÙ„:</label>
                    <div class="email-preview" id="email-preview">
                        <!-- Ù¾ÛŒØ´â€ŒÙ†Ù…Ø§ÛŒØ´ Ø§ÛŒÙ…ÛŒÙ„ -->
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-success" onclick="sendEmailNow()">
                    <i class="fas fa-paper-plane"></i> Ø§Ø±Ø³Ø§Ù„ Ø§ÛŒÙ…ÛŒÙ„
                </button>
                <button class="btn" onclick="closeModal('email-modal')">
                    <i class="fas fa-times"></i> Ø¨Ø³ØªÙ†
                </button>
            </div>
        </div>
    </div>

    <script>
        // Ù…ØªØºÛŒØ±Ù‡Ø§ÛŒ Ø³ÛŒØ³ØªÙ…
        let sellerSignaturePad = null;
        let currentInvoice = null;
        let invoiceCounter = parseInt(localStorage.getItem('invoiceCounter')) || 1;
        const MAX_HISTORY_ITEMS = 50;

        // Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø§ÙˆÙ„ÛŒÙ‡
        window.onload = function() {
            initializeSignaturePad();
            setDefaultDates();
            loadInvoiceTemplates();
            updateEmailPreview();
            
            // Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† event listener Ø¨Ø±Ø§ÛŒ Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ù¾ÛŒØ´â€ŒÙ†Ù…Ø§ÛŒØ´ Ø§ÛŒÙ…ÛŒÙ„
            document.getElementById('email-subject').addEventListener('input', updateEmailPreview);
            document.getElementById('email-recipient').addEventListener('input', updateEmailPreview);
        };

        // ØªÙ†Ø¸ÛŒÙ… ØªØ§Ø±ÛŒØ®â€ŒÙ‡Ø§ÛŒ Ù¾ÛŒØ´â€ŒÙØ±Ø¶
        function setDefaultDates() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('invoice-date').value = today;
            
            // ØªØ§Ø±ÛŒØ® Ø³Ø±Ø±Ø³ÛŒØ¯ Û· Ø±ÙˆØ² Ø¨Ø¹Ø¯
            const dueDate = new Date();
            dueDate.setDate(dueDate.getDate() + 7);
            document.getElementById('invoice-due-date').value = dueDate.toISOString().split('T')[0];
        }

        // Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ Ù¾Ø¯ Ø§Ù…Ø¶Ø§
        function initializeSignaturePad() {
            const canvas = document.getElementById('seller-signature-pad');
            if (canvas) {
                sellerSignaturePad = new SignaturePad(canvas, {
                    backgroundColor: 'white',
                    penColor: 'rgb(0, 0, 0)',
                    minWidth: 1,
                    maxWidth: 3
                });
                
                // ØªÙ†Ø¸ÛŒÙ… Ø³Ø§ÛŒØ² Ú©Ø§Ù†ÙˆØ§Ø³ Ø¨Ø±Ø§ÛŒ Ù…ÙˆØ¨Ø§ÛŒÙ„
                const resizeCanvas = () => {
                    const ratio = Math.max(window.devicePixelRatio || 1, 1);
                    canvas.width = canvas.offsetWidth * ratio;
                    canvas.height = canvas.offsetHeight * ratio;
                    canvas.getContext("2d").scale(ratio, ratio);
                    sellerSignaturePad.clear();
                };
                
                window.addEventListener("resize", resizeCanvas);
                resizeCanvas();
            }
        }

        // Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† Ø§Ù…Ø¶Ø§ÛŒ ÙØ±ÙˆØ´Ù†Ø¯Ù‡
        function clearSellerSignature() {
            if (sellerSignaturePad) {
                sellerSignaturePad.clear();
            }
        }

        // Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø§Ù…Ø¶Ø§ÛŒ Ù†Ù…ÙˆÙ†Ù‡
        function loadSampleSignature() {
            if (sellerSignaturePad) {
                showSuccessMessage('Ø§Ù…Ø¶Ø§ÛŒ Ù†Ù…ÙˆÙ†Ù‡ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø´Ø¯');
            }
        }

        // Ø§ÙØ²ÙˆØ¯Ù† Ø¢ÛŒØªÙ… Ø¬Ø¯ÛŒØ¯ Ø¨Ù‡ ÙØ§Ú©ØªÙˆØ±
        function addInvoiceItem() {
            const itemsContainer = document.getElementById('invoice-items');
            const itemRow = document.createElement('div');
            itemRow.className = 'invoice-item-row';
            itemRow.innerHTML = `
                <div style="display: grid; grid-template-columns: 2fr 1fr 1fr 1fr auto; gap: 10px; margin-bottom: 10px; align-items: center;">
                    <input type="text" placeholder="Ù†Ø§Ù… Ú©Ø§Ù„Ø§ / Ø®Ø¯Ù…Øª" class="item-name">
                    <input type="number" placeholder="ØªØ¹Ø¯Ø§Ø¯" class="item-quantity" value="1" min="1">
                    <input type="number" placeholder="Ù‚ÛŒÙ…Øª ÙˆØ§Ø­Ø¯" class="item-price">
                    <input type="number" placeholder="ØªØ®ÙÛŒÙ %" class="item-discount" value="0" min="0" max="100">
                    <button type="button" class="add-cost-btn danger" onclick="removeInvoiceItem(this)">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <textarea class="item-description" placeholder="ØªÙˆØ¶ÛŒØ­Ø§Øª Ú©Ø§Ù„Ø§ (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)" rows="2" style="width: 100%; margin-top: 8px; font-size: 0.9em;"></textarea>
            `;
            itemsContainer.appendChild(itemRow);
        }

        // Ø­Ø°Ù Ø¢ÛŒØªÙ… Ø§Ø² ÙØ§Ú©ØªÙˆØ±
        function removeInvoiceItem(button) {
            if (document.querySelectorAll('.invoice-item-row').length > 1) {
                button.closest('.invoice-item-row').remove();
            } else {
                alert('ÙØ§Ú©ØªÙˆØ± Ø¨Ø§ÛŒØ¯ Ø­Ø¯Ø§Ù‚Ù„ ÛŒÚ© Ø¢ÛŒØªÙ… Ø¯Ø§Ø´ØªÙ‡ Ø¨Ø§Ø´Ø¯');
            }
        }

        // ØªÙˆÙ„ÛŒØ¯ ÙØ§Ú©ØªÙˆØ±
        function generateInvoice() {
            // Ø¬Ù…Ø¹â€ŒØ¢ÙˆØ±ÛŒ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ù¾Ø§ÛŒÙ‡
            const type = document.getElementById('invoice-type').value;
            const number = document.getElementById('invoice-number').value || `FA-1403-${invoiceCounter.toString().padStart(3, '0')}`;
            const date = document.getElementById('invoice-date').value;
            const dueDate = document.getElementById('invoice-due-date').value;
            const seller = document.getElementById('invoice-seller').value;
            const sellerTaxId = document.getElementById('seller-tax-id').value;
            const sellerAddress = document.getElementById('seller-address').value;
            const sellerPhone = document.getElementById('seller-phone').value;
            const buyer = document.getElementById('invoice-buyer').value;
            const buyerTaxId = document.getElementById('buyer-tax-id').value;
            const buyerAddress = document.getElementById('buyer-address').value;
            const paymentTerms = document.getElementById('payment-terms').value;
            const notes = document.getElementById('invoice-notes').value;

            if (!seller || !buyer) {
                alert('Ù„Ø·ÙØ§Ù‹ Ø§Ø·Ù„Ø§Ø¹Ø§Øª ÙØ±ÙˆØ´Ù†Ø¯Ù‡ Ùˆ Ø®Ø±ÛŒØ¯Ø§Ø± Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯');
                return;
            }

            // Ø¬Ù…Ø¹â€ŒØ¢ÙˆØ±ÛŒ Ø¢ÛŒØªÙ…â€ŒÙ‡Ø§
            const items = [];
            let subtotal = 0;
            let totalDiscount = 0;
            
            document.querySelectorAll('.invoice-item-row').forEach(row => {
                const name = row.querySelector('.item-name').value;
                const quantity = parseInt(row.querySelector('.item-quantity').value) || 0;
                const price = parseInt(row.querySelector('.item-price').value) || 0;
                const discount = parseInt(row.querySelector('.item-discount').value) || 0;
                const description = row.querySelector('.item-description').value;

                if (name && quantity > 0 && price > 0) {
                    const itemTotal = quantity * price;
                    const itemDiscount = (itemTotal * discount) / 100;
                    const itemNet = itemTotal - itemDiscount;
                    
                    subtotal += itemTotal;
                    totalDiscount += itemDiscount;
                    
                    items.push({
                        name,
                        quantity,
                        price,
                        discount,
                        description,
                        total: itemTotal,
                        discountAmount: itemDiscount,
                        net: itemNet
                    });
                }
            });

            if (items.length === 0) {
                alert('Ù„Ø·ÙØ§Ù‹ Ø­Ø¯Ø§Ù‚Ù„ ÛŒÚ© Ú©Ø§Ù„Ø§ Ø¨Ù‡ ÙØ§Ú©ØªÙˆØ± Ø§Ø¶Ø§ÙÙ‡ Ú©Ù†ÛŒØ¯');
                return;
            }

            // Ù…Ø­Ø§Ø³Ø¨Ø§Øª Ù…Ø§Ù„ÛŒØ§ØªÛŒ
            const taxRate = 9; // 9% Ù…Ø§Ù„ÛŒØ§Øª Ø¨Ø± Ø§Ø±Ø²Ø´ Ø§ÙØ²ÙˆØ¯Ù‡
            const taxAmount = (subtotal - totalDiscount) * taxRate / 100;
            const totalAmount = subtotal - totalDiscount + taxAmount;

            // Ø§Ù…Ø¶Ø§
            let sellerSignature = null;
            if (sellerSignaturePad && !sellerSignaturePad.isEmpty()) {
                sellerSignature = sellerSignaturePad.toDataURL();
            }

            // Ø°Ø®ÛŒØ±Ù‡ Ø§Ø·Ù„Ø§Ø¹Ø§Øª ÙØ§Ú©ØªÙˆØ±
            currentInvoice = {
                id: Date.now(),
                type,
                number,
                date,
                dueDate,
                seller: {
                    name: seller,
                    taxId: sellerTaxId,
                    address: sellerAddress,
                    phone: sellerPhone
                },
                buyer: {
                    name: buyer,
                    taxId: buyerTaxId,
                    address: buyerAddress
                },
                items,
                subtotal,
                totalDiscount,
                taxRate,
                taxAmount,
                totalAmount,
                paymentTerms,
                notes,
                sellerSignature,
                createdAt: new Date().toLocaleDateString('fa-IR'),
                timestamp: Date.now()
            };

            // Ù†Ù…Ø§ÛŒØ´ Ù¾ÛŒØ´â€ŒÙ†Ù…Ø§ÛŒØ´
            displayInvoicePreview(currentInvoice);
            document.getElementById('invoice-actions').style.display = 'block';
            
            showSuccessMessage('ÙØ§Ú©ØªÙˆØ± Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø§ÛŒØ¬Ø§Ø¯ Ø´Ø¯');
            
            // Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ù¾ÛŒØ´â€ŒÙ†Ù…Ø§ÛŒØ´ Ø§ÛŒÙ…ÛŒÙ„
            updateEmailPreview();
        }

        // Ù†Ù…Ø§ÛŒØ´ Ù¾ÛŒØ´â€ŒÙ†Ù…Ø§ÛŒØ´ ÙØ§Ú©ØªÙˆØ±
        function displayInvoicePreview(invoice) {
            const previewContainer = document.getElementById('invoice-preview');
            
            const typeNames = {
                'sale': 'ÙØ±ÙˆØ´',
                'purchase': 'Ø®Ø±ÛŒØ¯',
                'proforma': 'Ù¾ÛŒØ´â€ŒÙØ§Ú©ØªÙˆØ±',
                'return': 'Ø¨Ø±Ú¯Ø´Øª Ø§Ø² ÙØ±ÙˆØ´'
            };

            const paymentTermsNames = {
                'cash': 'Ù†Ù‚Ø¯ÛŒ',
                'check': 'Ú†Ú©',
                'installment': 'Ø§Ù‚Ø³Ø§Ø·',
                'transfer': 'Ú©Ø§Ø±Øª Ø¨Ù‡ Ú©Ø§Ø±Øª'
            };

            let itemsHtml = '';
            invoice.items.forEach((item, index) => {
                itemsHtml += `
                    <tr>
                        <td>${index + 1}</td>
                        <td style="text-align: right;">
                            <div><strong>${item.name}</strong></div>
                            ${item.description ? `<div style="font-size: 0.8em; color: #666; margin-top: 5px;">${item.description}</div>` : ''}
                        </td>
                        <td>${item.quantity.toLocaleString()}</td>
                        <td>${item.price.toLocaleString()}</td>
                        <td>${item.discount}%</td>
                        <td>${item.discountAmount.toLocaleString()}</td>
                        <td>${item.net.toLocaleString()}</td>
                    </tr>
                `;
            });

            previewContainer.innerHTML = `
                <div class="invoice-header">
                    <h2>ÙØ§Ú©ØªÙˆØ± ${typeNames[invoice.type]}</h2>
                    <p><strong>Ø´Ù…Ø§Ø±Ù‡:</strong> ${invoice.number} | <strong>ØªØ§Ø±ÛŒØ®:</strong> ${formatDate(invoice.date)}</p>
                    ${invoice.dueDate ? `<p><strong>ØªØ§Ø±ÛŒØ® Ø³Ø±Ø±Ø³ÛŒØ¯:</strong> ${formatDate(invoice.dueDate)}</p>` : ''}
                </div>

                <div class="invoice-details">
                    <div>
                        <h4>ÙØ±ÙˆØ´Ù†Ø¯Ù‡:</h4>
                        <p><strong>${invoice.seller.name}</strong></p>
                        ${invoice.seller.taxId ? `<p>Ú©Ø¯ Ø§Ù‚ØªØµØ§Ø¯ÛŒ: ${invoice.seller.taxId}</p>` : ''}
                        ${invoice.seller.address ? `<p>Ø¢Ø¯Ø±Ø³: ${invoice.seller.address}</p>` : ''}
                        ${invoice.seller.phone ? `<p>ØªÙ„ÙÙ†: ${invoice.seller.phone}</p>` : ''}
                    </div>
                    <div>
                        <h4>Ø®Ø±ÛŒØ¯Ø§Ø±:</h4>
                        <p><strong>${invoice.buyer.name}</strong></p>
                        ${invoice.buyer.taxId ? `<p>Ú©Ø¯ Ø§Ù‚ØªØµØ§Ø¯ÛŒ: ${invoice.buyer.taxId}</p>` : ''}
                        ${invoice.buyer.address ? `<p>Ø¢Ø¯Ø±Ø³: ${invoice.buyer.address}</p>` : ''}
                    </div>
                </div>

                <table class="invoice-items">
                    <thead>
                        <tr>
                            <th>Ø±Ø¯ÛŒÙ</th>
                            <th>Ø´Ø±Ø­ Ú©Ø§Ù„Ø§ / Ø®Ø¯Ù…Øª</th>
                            <th>ØªØ¹Ø¯Ø§Ø¯</th>
                            <th>Ù‚ÛŒÙ…Øª ÙˆØ§Ø­Ø¯ (ØªÙˆÙ…Ø§Ù†)</th>
                            <th>ØªØ®ÙÛŒÙ %</th>
                            <th>Ù…Ø¨Ù„Øº ØªØ®ÙÛŒÙ (ØªÙˆÙ…Ø§Ù†)</th>
                            <th>Ø¬Ù…Ø¹ (ØªÙˆÙ…Ø§Ù†)</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${itemsHtml}
                    </tbody>
                </table>

                <div class="tax-calculations" style="page-break-inside: avoid;">
                    <div class="tax-row">
                        <span>Ø¬Ù…Ø¹ Ú©Ù„:</span>
                        <span>${invoice.subtotal.toLocaleString()} ØªÙˆÙ…Ø§Ù†</span>
                    </div>
                    <div class="tax-row">
                        <span>ØªØ®ÙÛŒÙ:</span>
                        <span>${invoice.totalDiscount.toLocaleString()} ØªÙˆÙ…Ø§Ù†</span>
                    </div>
                    <div class="tax-row">
                        <span>Ù…Ø§Ù„ÛŒØ§Øª Ø¨Ø± Ø§Ø±Ø²Ø´ Ø§ÙØ²ÙˆØ¯Ù‡ (${invoice.taxRate}%):</span>
                        <span>${invoice.taxAmount.toLocaleString()} ØªÙˆÙ…Ø§Ù†</span>
                    </div>
                    <div class="tax-row" style="border-top: 1px solid #ddd; padding-top: 8px; font-weight: bold; font-size: 1.1em;">
                        <span>Ù…Ø¨Ù„Øº Ù‚Ø§Ø¨Ù„ Ù¾Ø±Ø¯Ø§Ø®Øª:</span>
                        <span>${invoice.totalAmount.toLocaleString()} ØªÙˆÙ…Ø§Ù†</span>
                    </div>
                </div>

                ${invoice.notes ? `
                    <div style="margin-top: 20px; padding: 15px; background: #f8fafc; border-radius: 8px; border-right: 3px solid var(--primary); page-break-inside: avoid;">
                        <strong>ØªÙˆØ¶ÛŒØ­Ø§Øª:</strong> ${invoice.notes}
                    </div>
                ` : ''}

                <div style="margin-top: 20px; padding: 12px; background: #f0f9ff; border-radius: 8px; page-break-inside: avoid;">
                    <strong>Ø´Ø±Ø§ÛŒØ· Ù¾Ø±Ø¯Ø§Ø®Øª:</strong> ${paymentTermsNames[invoice.paymentTerms]}
                </div>

                <div class="invoice-signatures" style="page-break-inside: avoid;">
                    <div class="signature-box">
                        <div style="font-weight: bold; margin-bottom: 10px;">Ø§Ù…Ø¶Ø§ Ùˆ Ù…Ù‡Ø± ÙØ±ÙˆØ´Ù†Ø¯Ù‡</div>
                        ${invoice.sellerSignature ? 
                            `<img src="${invoice.sellerSignature}" style="max-width: 200px; max-height: 80px; margin-top: 10px; border: 1px solid #ccc; border-radius: 4px;">` : 
                            '<div class="signature-line"></div>'
                        }
                    </div>
                    <div class="signature-box">
                        <div style="font-weight: bold; margin-bottom: 10px;">Ø§Ù…Ø¶Ø§ Ø®Ø±ÛŒØ¯Ø§Ø±</div>
                        <div class="signature-line"></div>
                    </div>
                </div>

                <div style="text-align: center; margin-top: 25px; font-size: 0.85em; color: #666; padding-top: 15px; border-top: 1px solid #e2e8f0; page-break-inside: avoid;">
                    Ø§ÛŒÙ† ÙØ§Ú©ØªÙˆØ± Ø¨Ù‡ ØµÙˆØ±Øª Ø§Ù„Ú©ØªØ±ÙˆÙ†ÛŒÚ©ÛŒ ØµØ§Ø¯Ø± Ø´Ø¯Ù‡ Ùˆ Ù†ÛŒØ§Ø² Ø¨Ù‡ Ù…Ù‡Ø± Ùˆ Ø§Ù…Ø¶Ø§ÛŒ ÙÛŒØ²ÛŒÚ©ÛŒ Ù†Ø¯Ø§Ø±Ø¯
                </div>
            `;

            previewContainer.style.display = 'block';
            
            // Ø§Ø³Ú©Ø±ÙˆÙ„ Ø¨Ù‡ Ø¨Ø®Ø´ Ù¾ÛŒØ´â€ŒÙ†Ù…Ø§ÛŒØ´
            previewContainer.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        // Ø¯Ø§Ù†Ù„ÙˆØ¯ ÙØ§Ú©ØªÙˆØ± Ø¨Ù‡ ØµÙˆØ±Øª PDF
        function downloadInvoiceAsPDF() {
            if (!currentInvoice) {
                alert('Ù„Ø·ÙØ§Ù‹ Ø§Ø¨ØªØ¯Ø§ ÙØ§Ú©ØªÙˆØ± Ø±Ø§ Ø§ÛŒØ¬Ø§Ø¯ Ú©Ù†ÛŒØ¯');
                return;
            }

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            const invoiceContent = document.getElementById('invoice-preview');
            
            html2canvas(invoiceContent, { 
                scale: 2, 
                useCORS: true, 
                logging: false,
                backgroundColor: '#ffffff',
                windowWidth: invoiceContent.scrollWidth,
                windowHeight: invoiceContent.scrollHeight
            }).then(canvas => {
                const imgData = canvas.toDataURL('image/png');
                const imgWidth = 190;
                const pageHeight = 280;
                const imgHeight = canvas.height * imgWidth / canvas.width;
                let heightLeft = imgHeight;
                let position = 10;

                doc.addImage(imgData, 'PNG', 10, position, imgWidth, imgHeight);
                heightLeft -= pageHeight;

                while (heightLeft >= 0) {
                    position = heightLeft - imgHeight;
                    doc.addPage();
                    doc.addImage(imgData, 'PNG', 10, position, imgWidth, imgHeight);
                    heightLeft -= pageHeight;
                }

                doc.save(`ÙØ§Ú©ØªÙˆØ±_${currentInvoice.number}.pdf`);
                showSuccessMessage('ÙØ§Ú©ØªÙˆØ± Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø¯Ø§Ù†Ù„ÙˆØ¯ Ø´Ø¯');
            }).catch(error => {
                console.error('Ø®Ø·Ø§ Ø¯Ø± Ø§ÛŒØ¬Ø§Ø¯ PDF:', error);
                alert('Ø®Ø·Ø§ Ø¯Ø± Ø§ÛŒØ¬Ø§Ø¯ ÙØ§ÛŒÙ„ PDF. Ù„Ø·ÙØ§Ù‹ Ø¯ÙˆØ¨Ø§Ø±Ù‡ ØªÙ„Ø§Ø´ Ú©Ù†ÛŒØ¯.');
            });
        }

        // Ú†Ø§Ù¾ ÙØ§Ú©ØªÙˆØ± - Ù†Ø³Ø®Ù‡ Ø¨Ù‡Ø¨ÙˆØ¯ ÛŒØ§ÙØªÙ‡
        function printInvoice() {
            if (!currentInvoice) {
                alert('Ù„Ø·ÙØ§Ù‹ Ø§Ø¨ØªØ¯Ø§ ÙØ§Ú©ØªÙˆØ± Ø±Ø§ Ø§ÛŒØ¬Ø§Ø¯ Ú©Ù†ÛŒØ¯');
                return;
            }
            
            const typeNames = {
                'sale': 'ÙØ±ÙˆØ´',
                'purchase': 'Ø®Ø±ÛŒØ¯',
                'proforma': 'Ù¾ÛŒØ´â€ŒÙØ§Ú©ØªÙˆØ±',
                'return': 'Ø¨Ø±Ú¯Ø´Øª Ø§Ø² ÙØ±ÙˆØ´'
            };

            const paymentTermsNames = {
                'cash': 'Ù†Ù‚Ø¯ÛŒ',
                'check': 'Ú†Ú©',
                'installment': 'Ø§Ù‚Ø³Ø§Ø·',
                'transfer': 'Ú©Ø§Ø±Øª Ø¨Ù‡ Ú©Ø§Ø±Øª'
            };

            let itemsHtml = '';
            currentInvoice.items.forEach((item, index) => {
                itemsHtml += `
                    <tr>
                        <td>${index + 1}</td>
                        <td style="text-align: right; font-size: 9px;">
                            <div><strong>${item.name}</strong></div>
                            ${item.description ? `<div style="color: #666;">${item.description}</div>` : ''}
                        </td>
                        <td>${item.quantity.toLocaleString()}</td>
                        <td>${item.price.toLocaleString()}</td>
                        <td>${item.discount}%</td>
                        <td>${item.discountAmount.toLocaleString()}</td>
                        <td>${item.net.toLocaleString()}</td>
                    </tr>
                `;
            });

            const printContent = `
                <!DOCTYPE html>
                <html dir="rtl">
                <head>
                    <title>Ú†Ø§Ù¾ ÙØ§Ú©ØªÙˆØ± ${currentInvoice.number}</title>
                    <meta charset="UTF-8">
                    <meta name="viewport" content="width=device-width, initial-scale=1.0">
                    <style>
                        @font-face {
                            font-family: 'Vazirmatn';
                            src: url('https://cdn.jsdelivr.net/gh/rastikerdar/vazirmatn@v33.003/fonts/webfonts/Vazirmatn-Regular.woff2') format('woff2');
                        }
                        * {
                            margin: 0;
                            padding: 0;
                            box-sizing: border-box;
                        }
                        body {
                            font-family: 'Vazirmatn', Tahoma, Arial, sans-serif;
                            color: #000;
                            line-height: 1.3;
                            font-size: 11px;
                            padding: 10px;
                            background: white;
                        }
                        .invoice-container {
                            width: 100%;
                            max-width: 100%;
                            page-break-inside: avoid;
                        }
                        .invoice-header {
                            text-align: center;
                            margin-bottom: 15px;
                            padding-bottom: 10px;
                            border-bottom: 2px solid #000;
                        }
                        .invoice-header h2 {
                            font-size: 16px;
                            margin-bottom: 5px;
                        }
                        .invoice-header p {
                            font-size: 10px;
                            margin: 2px 0;
                        }
                        .invoice-details {
                            display: grid;
                            grid-template-columns: 1fr 1fr;
                            gap: 10px;
                            margin-bottom: 15px;
                            font-size: 9px;
                        }
                        .invoice-details h4 {
                            font-size: 11px;
                            margin-bottom: 3px;
                            border-bottom: 1px solid #ccc;
                            padding-bottom: 2px;
                        }
                        .invoice-details p {
                            margin: 1px 0;
                        }
                        .invoice-table {
                            width: 100%;
                            border-collapse: collapse;
                            margin: 10px 0;
                            font-size: 9px;
                            table-layout: fixed;
                        }
                        .invoice-table th, .invoice-table td {
                            border: 1px solid #000;
                            padding: 4px;
                            text-align: center;
                            word-wrap: break-word;
                        }
                        .invoice-table th {
                            background-color: #f0f0f0;
                            font-weight: bold;
                        }
                        .tax-calculations {
                            background: #f8f8f8;
                            padding: 10px;
                            margin: 10px 0;
                            border: 1px solid #000;
                            font-size: 10px;
                        }
                        .tax-row {
                            display: flex;
                            justify-content: space-between;
                            margin-bottom: 4px;
                        }
                        .total-row {
                            border-top: 1px solid #000;
                            padding-top: 6px;
                            font-weight: bold;
                            font-size: 11px;
                        }
                        .invoice-signatures {
                            display: flex;
                            justify-content: space-between;
                            margin-top: 30px;
                            font-size: 10px;
                        }
                        .signature-box {
                            text-align: center;
                            width: 45%;
                        }
                        .signature-line {
                            border-top: 1px solid #000;
                            margin-top: 40px;
                            padding-top: 5px;
                        }
                        .notes-box {
                            margin-top: 15px;
                            padding: 8px;
                            border: 1px solid #ccc;
                            font-size: 9px;
                        }
                        @media print {
                            @page {
                                size: landscape;
                                margin: 10mm;
                            }
                            body {
                                margin: 0;
                                padding: 0;
                            }
                            .invoice-container {
                                width: 100%;
                                max-width: 100%;
                            }
                            .invoice-table {
                                font-size: 8px;
                            }
                            .invoice-table th, .invoice-table td {
                                padding: 3px;
                            }
                        }
                    </style>
                </head>
                <body>
                    <div class="invoice-container">
                        <div class="invoice-header">
                            <h2>ÙØ§Ú©ØªÙˆØ± ${typeNames[currentInvoice.type]}</h2>
                            <p><strong>Ø´Ù…Ø§Ø±Ù‡:</strong> ${currentInvoice.number} | <strong>ØªØ§Ø±ÛŒØ®:</strong> ${formatDate(currentInvoice.date)}</p>
                            ${currentInvoice.dueDate ? `<p><strong>ØªØ§Ø±ÛŒØ® Ø³Ø±Ø±Ø³ÛŒØ¯:</strong> ${formatDate(currentInvoice.dueDate)}</p>` : ''}
                        </div>

                        <div class="invoice-details">
                            <div>
                                <h4>ÙØ±ÙˆØ´Ù†Ø¯Ù‡:</h4>
                                <p><strong>${currentInvoice.seller.name}</strong></p>
                                ${currentInvoice.seller.taxId ? `<p>Ú©Ø¯ Ø§Ù‚ØªØµØ§Ø¯ÛŒ: ${currentInvoice.seller.taxId}</p>` : ''}
                                ${currentInvoice.seller.address ? `<p>Ø¢Ø¯Ø±Ø³: ${currentInvoice.seller.address}</p>` : ''}
                                ${currentInvoice.seller.phone ? `<p>ØªÙ„ÙÙ†: ${currentInvoice.seller.phone}</p>` : ''}
                            </div>
                            <div>
                                <h4>Ø®Ø±ÛŒØ¯Ø§Ø±:</h4>
                                <p><strong>${currentInvoice.buyer.name}</strong></p>
                                ${currentInvoice.buyer.taxId ? `<p>Ú©Ø¯ Ø§Ù‚ØªØµØ§Ø¯ÛŒ: ${currentInvoice.buyer.taxId}</p>` : ''}
                                ${currentInvoice.buyer.address ? `<p>Ø¢Ø¯Ø±Ø³: ${currentInvoice.buyer.address}</p>` : ''}
                            </div>
                        </div>

                        <table class="invoice-table">
                            <thead>
                                <tr>
                                    <th style="width: 5%;">Ø±Ø¯ÛŒÙ</th>
                                    <th style="width: 30%;">Ø´Ø±Ø­ Ú©Ø§Ù„Ø§ / Ø®Ø¯Ù…Øª</th>
                                    <th style="width: 8%;">ØªØ¹Ø¯Ø§Ø¯</th>
                                    <th style="width: 12%;">Ù‚ÛŒÙ…Øª ÙˆØ§Ø­Ø¯ (ØªÙˆÙ…Ø§Ù†)</th>
                                    <th style="width: 8%;">ØªØ®ÙÛŒÙ %</th>
                                    <th style="width: 12%;">Ù…Ø¨Ù„Øº ØªØ®ÙÛŒÙ (ØªÙˆÙ…Ø§Ù†)</th>
                                    <th style="width: 12%;">Ø¬Ù…Ø¹ (ØªÙˆÙ…Ø§Ù†)</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${itemsHtml}
                            </tbody>
                        </table>

                        <div class="tax-calculations">
                            <div class="tax-row">
                                <span>Ø¬Ù…Ø¹ Ú©Ù„:</span>
                                <span>${currentInvoice.subtotal.toLocaleString()} ØªÙˆÙ…Ø§Ù†</span>
                            </div>
                            <div class="tax-row">
                                <span>ØªØ®ÙÛŒÙ:</span>
                                <span>${currentInvoice.totalDiscount.toLocaleString()} ØªÙˆÙ…Ø§Ù†</span>
                            </div>
                            <div class="tax-row">
                                <span>Ù…Ø§Ù„ÛŒØ§Øª Ø¨Ø± Ø§Ø±Ø²Ø´ Ø§ÙØ²ÙˆØ¯Ù‡ (${currentInvoice.taxRate}%):</span>
                                <span>${currentInvoice.taxAmount.toLocaleString()} ØªÙˆÙ…Ø§Ù†</span>
                            </div>
                            <div class="tax-row total-row">
                                <span>Ù…Ø¨Ù„Øº Ù‚Ø§Ø¨Ù„ Ù¾Ø±Ø¯Ø§Ø®Øª:</span>
                                <span>${currentInvoice.totalAmount.toLocaleString()} ØªÙˆÙ…Ø§Ù†</span>
                            </div>
                        </div>

                        ${currentInvoice.notes ? `
                            <div class="notes-box">
                                <strong>ØªÙˆØ¶ÛŒØ­Ø§Øª:</strong> ${currentInvoice.notes}
                            </div>
                        ` : ''}

                        <div style="margin-top: 10px; padding: 5px; font-size: 10px;">
                            <strong>Ø´Ø±Ø§ÛŒØ· Ù¾Ø±Ø¯Ø§Ø®Øª:</strong> ${paymentTermsNames[currentInvoice.paymentTerms]}
                        </div>

                        <div class="invoice-signatures">
                            <div class="signature-box">
                                <div>Ø§Ù…Ø¶Ø§ Ùˆ Ù…Ù‡Ø± ÙØ±ÙˆØ´Ù†Ø¯Ù‡</div>
                                ${currentInvoice.sellerSignature ? 
                                    `<img src="${currentInvoice.sellerSignature}" style="max-width: 150px; max-height: 60px; margin-top: 5px; border: 1px solid #ccc;">` : 
                                    '<div class="signature-line"></div>'
                                }
                            </div>
                            <div class="signature-box">
                                <div>Ø§Ù…Ø¶Ø§ Ø®Ø±ÛŒØ¯Ø§Ø±</div>
                                <div class="signature-line"></div>
                            </div>
                        </div>

                        <div style="text-align: center; margin-top: 20px; font-size: 8px; color: #666; padding-top: 10px; border-top: 1px solid #ccc;">
                            Ø§ÛŒÙ† ÙØ§Ú©ØªÙˆØ± Ø¨Ù‡ ØµÙˆØ±Øª Ø§Ù„Ú©ØªØ±ÙˆÙ†ÛŒÚ©ÛŒ ØµØ§Ø¯Ø± Ø´Ø¯Ù‡ Ùˆ Ù†ÛŒØ§Ø² Ø¨Ù‡ Ù…Ù‡Ø± Ùˆ Ø§Ù…Ø¶Ø§ÛŒ ÙÛŒØ²ÛŒÚ©ÛŒ Ù†Ø¯Ø§Ø±Ø¯
                        </div>
                    </div>
                    <script>
                        window.onload = function() {
                            window.print();
                            setTimeout(function() {
                                window.close();
                            }, 500);
                        };
                    <\/script>
                </body>
                </html>
            `;
            
            const printWindow = window.open('', '_blank');
            printWindow.document.write(printContent);
            printWindow.document.close();
        }

        // Ø§Ø±Ø³Ø§Ù„ ÙØ§Ú©ØªÙˆØ± Ø§Ø² Ø·Ø±ÛŒÙ‚ Ø§ÛŒÙ…ÛŒÙ„
        function sendInvoiceByEmail() {
            if (!currentInvoice) {
                alert('Ù„Ø·ÙØ§Ù‹ Ø§Ø¨ØªØ¯Ø§ ÙØ§Ú©ØªÙˆØ± Ø±Ø§ Ø§ÛŒØ¬Ø§Ø¯ Ú©Ù†ÛŒØ¯');
                return;
            }
            
            // ØªÙ†Ø¸ÛŒÙ… Ù…ÙˆØ¶ÙˆØ¹ Ø§ÛŒÙ…ÛŒÙ„
            document.getElementById('email-subject').value = `ÙØ§Ú©ØªÙˆØ± ${currentInvoice.number} - ${currentInvoice.seller.name}`;
            
            // Ù†Ù…Ø§ÛŒØ´ Ù…ÙˆØ¯Ø§Ù„ Ø§ÛŒÙ…ÛŒÙ„
            document.getElementById('email-modal').style.display = 'flex';
            updateEmailPreview();
        }

        // Ø§Ø±Ø³Ø§Ù„ Ø§ÛŒÙ…ÛŒÙ„ ÙˆØ§Ù‚Ø¹ÛŒ
        function sendEmailNow() {
            const recipient = document.getElementById('email-recipient').value.trim();
            const subject = document.getElementById('email-subject').value.trim();
            
            if (!recipient) {
                alert('Ù„Ø·ÙØ§Ù‹ Ø§ÛŒÙ…ÛŒÙ„ Ø¯Ø±ÛŒØ§ÙØª Ú©Ù†Ù†Ø¯Ù‡ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯');
                return;
            }
            
            if (!currentInvoice) {
                alert('Ù‡ÛŒÚ† ÙØ§Ú©ØªÙˆØ±ÛŒ Ø¨Ø±Ø§ÛŒ Ø§Ø±Ø³Ø§Ù„ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯');
                return;
            }
            
            // Ø§ÛŒØ¬Ø§Ø¯ Ù…Ø­ØªÙˆØ§ÛŒ Ø§ÛŒÙ…ÛŒÙ„
            const emailBody = createEmailContent();
            
            // ØªÙ‚Ø³ÛŒÙ… Ø§ÛŒÙ…ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ú†Ù†Ø¯Ú¯Ø§Ù†Ù‡
            const emails = recipient.split(',').map(email => email.trim()).filter(email => email);
            
            // Ø§ÛŒØ¬Ø§Ø¯ Ù„ÛŒÙ†Ú© mailto Ø¨Ø±Ø§ÛŒ Ù‡Ø± Ø§ÛŒÙ…ÛŒÙ„
            emails.forEach(email => {
                const mailtoLink = `mailto:${email}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(emailBody)}`;
                window.open(mailtoLink, '_blank');
            });
            
            showSuccessMessage(`Ø§ÛŒÙ…ÛŒÙ„ Ø¨Ø±Ø§ÛŒ ${emails.length} Ø¯Ø±ÛŒØ§ÙØª Ú©Ù†Ù†Ø¯Ù‡ Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯`);
            closeModal('email-modal');
            
            // Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† ÙÛŒÙ„Ø¯ Ø§ÛŒÙ…ÛŒÙ„
            document.getElementById('email-recipient').value = '';
        }

        // Ø§ÛŒØ¬Ø§Ø¯ Ù…Ø­ØªÙˆØ§ÛŒ Ø§ÛŒÙ…ÛŒÙ„
        function createEmailContent() {
            if (!currentInvoice) return '';
            
            const typeNames = {
                'sale': 'ÙØ±ÙˆØ´',
                'purchase': 'Ø®Ø±ÛŒØ¯',
                'proforma': 'Ù¾ÛŒØ´â€ŒÙØ§Ú©ØªÙˆØ±',
                'return': 'Ø¨Ø±Ú¯Ø´Øª Ø§Ø² ÙØ±ÙˆØ´'
            };
            
            const paymentTermsNames = {
                'cash': 'Ù†Ù‚Ø¯ÛŒ',
                'check': 'Ú†Ú©',
                'installment': 'Ø§Ù‚Ø³Ø§Ø·',
                'transfer': 'Ú©Ø§Ø±Øª Ø¨Ù‡ Ú©Ø§Ø±Øª'
            };
            
            let itemsText = '';
            currentInvoice.items.forEach((item, index) => {
                itemsText += `${index + 1}. ${item.name} - ØªØ¹Ø¯Ø§Ø¯: ${item.quantity} - Ù‚ÛŒÙ…Øª: ${item.price.toLocaleString()} ØªÙˆÙ…Ø§Ù† - ØªØ®ÙÛŒÙ: ${item.discount}%\n`;
                if (item.description) {
                    itemsText += `   ØªÙˆØ¶ÛŒØ­Ø§Øª: ${item.description}\n`;
                }
                itemsText += `   Ø¬Ù…Ø¹: ${item.net.toLocaleString()} ØªÙˆÙ…Ø§Ù†\n\n`;
            });
            
            return `
ÙØ§Ú©ØªÙˆØ± ${typeNames[currentInvoice.type]}

Ø´Ù…Ø§Ø±Ù‡ ÙØ§Ú©ØªÙˆØ±: ${currentInvoice.number}
ØªØ§Ø±ÛŒØ®: ${formatDate(currentInvoice.date)}
${currentInvoice.dueDate ? `ØªØ§Ø±ÛŒØ® Ø³Ø±Ø±Ø³ÛŒØ¯: ${formatDate(currentInvoice.dueDate)}` : ''}

ÙØ±ÙˆØ´Ù†Ø¯Ù‡:
${currentInvoice.seller.name}
${currentInvoice.seller.taxId ? `Ú©Ø¯ Ø§Ù‚ØªØµØ§Ø¯ÛŒ: ${currentInvoice.seller.taxId}` : ''}
${currentInvoice.seller.address ? `Ø¢Ø¯Ø±Ø³: ${currentInvoice.seller.address}` : ''}
${currentInvoice.seller.phone ? `ØªÙ„ÙÙ†: ${currentInvoice.seller.phone}` : ''}

Ø®Ø±ÛŒØ¯Ø§Ø±:
${currentInvoice.buyer.name}
${currentInvoice.buyer.taxId ? `Ú©Ø¯ Ø§Ù‚ØªØµØ§Ø¯ÛŒ: ${currentInvoice.buyer.taxId}` : ''}
${currentInvoice.buyer.address ? `Ø¢Ø¯Ø±Ø³: ${currentInvoice.buyer.address}` : ''}

Ù…Ø´Ø®ØµØ§Øª Ú©Ø§Ù„Ø§/Ø®Ø¯Ù…Ø§Øª:
${itemsText}

Ø®Ù„Ø§ØµÙ‡ Ù…Ø§Ù„ÛŒ:
Ø¬Ù…Ø¹ Ú©Ù„: ${currentInvoice.subtotal.toLocaleString()} ØªÙˆÙ…Ø§Ù†
ØªØ®ÙÛŒÙ: ${currentInvoice.totalDiscount.toLocaleString()} ØªÙˆÙ…Ø§Ù†
Ù…Ø§Ù„ÛŒØ§Øª Ø¨Ø± Ø§Ø±Ø²Ø´ Ø§ÙØ²ÙˆØ¯Ù‡ (${currentInvoice.taxRate}%): ${currentInvoice.taxAmount.toLocaleString()} ØªÙˆÙ…Ø§Ù†
Ù…Ø¨Ù„Øº Ù‚Ø§Ø¨Ù„ Ù¾Ø±Ø¯Ø§Ø®Øª: ${currentInvoice.totalAmount.toLocaleString()} ØªÙˆÙ…Ø§Ù†

Ø´Ø±Ø§ÛŒØ· Ù¾Ø±Ø¯Ø§Ø®Øª: ${paymentTermsNames[currentInvoice.paymentTerms]}
${currentInvoice.notes ? `ØªÙˆØ¶ÛŒØ­Ø§Øª: ${currentInvoice.notes}` : ''}

Ø§ÛŒÙ† ÙØ§Ú©ØªÙˆØ± Ø¨Ù‡ ØµÙˆØ±Øª Ø§Ù„Ú©ØªØ±ÙˆÙ†ÛŒÚ©ÛŒ ØµØ§Ø¯Ø± Ø´Ø¯Ù‡ Ø§Ø³Øª.
Ø¨Ø§ ØªØ´Ú©Ø±
${currentInvoice.seller.name}
            `.trim();
        }

        // Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ù¾ÛŒØ´â€ŒÙ†Ù…Ø§ÛŒØ´ Ø§ÛŒÙ…ÛŒÙ„
        function updateEmailPreview() {
            const emailPreview = document.getElementById('email-preview');
            const recipient = document.getElementById('email-recipient').value;
            const subject = document.getElementById('email-subject').value;
            
            if (!currentInvoice) {
                emailPreview.innerHTML = '<div style="color: #666; text-align: center; padding: 20px;">Ù„Ø·ÙØ§Ù‹ Ø§Ø¨ØªØ¯Ø§ ÙØ§Ú©ØªÙˆØ± Ø±Ø§ Ø§ÛŒØ¬Ø§Ø¯ Ú©Ù†ÛŒØ¯</div>';
                return;
            }
            
            let previewHtml = `
                <div><strong>Ø¨Ù‡:</strong> ${recipient || 'Ø§ÛŒÙ…ÛŒÙ„ Ø¯Ø±ÛŒØ§ÙØª Ú©Ù†Ù†Ø¯Ù‡'}</div>
                <div><strong>Ù…ÙˆØ¶ÙˆØ¹:</strong> ${subject || 'Ù…ÙˆØ¶ÙˆØ¹ Ø§ÛŒÙ…ÛŒÙ„'}</div>
                <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid #ddd;">
                    <div>ÛŒÚ© ÙØ§Ú©ØªÙˆØ± Ø¬Ø¯ÛŒØ¯ Ø§Ø² Ø·Ø±Ù <strong>${currentInvoice.seller.name}</strong> Ø¨Ø±Ø§ÛŒ Ø´Ù…Ø§ Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯Ù‡ Ø§Ø³Øª.</div>
                    <div style="margin-top: 8px;"><strong>Ø´Ù…Ø§Ø±Ù‡ ÙØ§Ú©ØªÙˆØ±:</strong> ${currentInvoice.number}</div>
                    <div><strong>Ù…Ø¨Ù„Øº Ù‚Ø§Ø¨Ù„ Ù¾Ø±Ø¯Ø§Ø®Øª:</strong> ${currentInvoice.totalAmount.toLocaleString()} ØªÙˆÙ…Ø§Ù†</div>
                </div>
            `;
            
            emailPreview.innerHTML = previewHtml;
        }

        // Ø°Ø®ÛŒØ±Ù‡ ÙØ§Ú©ØªÙˆØ± Ø¯Ø± ØªØ§Ø±ÛŒØ®Ú†Ù‡
        function saveInvoiceToHistory() {
            if (!currentInvoice) {
                alert('Ù„Ø·ÙØ§Ù‹ Ø§Ø¨ØªØ¯Ø§ ÙØ§Ú©ØªÙˆØ± Ø±Ø§ Ø§ÛŒØ¬Ø§Ø¯ Ú©Ù†ÛŒØ¯');
                return;
            }

            // Ø¯Ø±ÛŒØ§ÙØª ØªØ§Ø±ÛŒØ®Ú†Ù‡ Ù…ÙˆØ¬ÙˆØ¯
            let invoices = JSON.parse(localStorage.getItem('invoices')) || [];
            
            // Ø¨Ø±Ø±Ø³ÛŒ ÙˆØ¬ÙˆØ¯ ÙØ§Ú©ØªÙˆØ± Ø¨Ø§ Ù‡Ù…Ø§Ù† Ø´Ù…Ø§Ø±Ù‡
            const existingIndex = invoices.findIndex(inv => inv.id === currentInvoice.id);
            if (existingIndex !== -1) {
                invoices[existingIndex] = currentInvoice;
            } else {
                // Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† ÙØ§Ú©ØªÙˆØ± Ø¬Ø¯ÛŒØ¯
                invoices.push(currentInvoice);
                
                // Ù…Ø­Ø¯ÙˆØ¯ Ú©Ø±Ø¯Ù† ØªØ¹Ø¯Ø§Ø¯ ÙØ§Ú©ØªÙˆØ±Ù‡Ø§ Ø¨Ù‡ ÛµÛ° Ø¹Ø¯Ø¯
                if (invoices.length > MAX_HISTORY_ITEMS) {
                    invoices = invoices.slice(-MAX_HISTORY_ITEMS);
                }
            }
            
            // Ø°Ø®ÛŒØ±Ù‡ Ø¯Ø± localStorage
            localStorage.setItem('invoices', JSON.stringify(invoices));
            
            // Ø§ÙØ²Ø§ÛŒØ´ Ø´Ù…Ø§Ø±Ù†Ø¯Ù‡ ÙØ§Ú©ØªÙˆØ±
            invoiceCounter++;
            localStorage.setItem('invoiceCounter', invoiceCounter.toString());
            
            showSuccessMessage('ÙØ§Ú©ØªÙˆØ± Ø¯Ø± ØªØ§Ø±ÛŒØ®Ú†Ù‡ Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯');
        }

        // Ù†Ù…Ø§ÛŒØ´ ØªØ§Ø±ÛŒØ®Ú†Ù‡ ÙØ§Ú©ØªÙˆØ±Ù‡Ø§
        function showHistory() {
            const invoices = JSON.parse(localStorage.getItem('invoices')) || [];
            const historyList = document.getElementById('history-list');
            
            if (invoices.length === 0) {
                historyList.innerHTML = `
                    <div style="text-align: center; padding: 40px 20px; color: #666;">
                        <i class="fas fa-inbox" style="font-size: 3em; margin-bottom: 15px;"></i>
                        <div>ØªØ§Ø±ÛŒØ®Ú†Ù‡ ÙØ§Ú©ØªÙˆØ±Ù‡Ø§ Ø®Ø§Ù„ÛŒ Ø§Ø³Øª</div>
                    </div>
                `;
            } else {
                let historyHtml = '';
                // Ù†Ù…Ø§ÛŒØ´ Ø¨Ù‡ ØªØ±ØªÛŒØ¨ Ù…Ø¹Ú©ÙˆØ³ (Ø¬Ø¯ÛŒØ¯ØªØ±ÛŒÙ† Ø§ÙˆÙ„)
                [...invoices].reverse().forEach((invoice, index) => {
                    historyHtml += `
                        <div class="history-item">
                            <div class="history-info">
                                <div style="font-weight: bold;">${invoice.number}</div>
                                <div style="font-size: 0.9em;">${invoice.seller.name} â†’ ${invoice.buyer.name}</div>
                                <div class="history-date">${invoice.createdAt} - ${formatNumber(invoice.totalAmount)} ØªÙˆÙ…Ø§Ù†</div>
                            </div>
                            <div>
                                <button class="add-cost-btn" onclick="restoreInvoice('${invoice.id}')" style="font-size: 0.8em;">
                                    <i class="fas fa-eye"></i> Ù…Ø´Ø§Ù‡Ø¯Ù‡
                                </button>
                            </div>
                        </div>
                    `;
                });
                historyList.innerHTML = historyHtml;
            }
            
            document.getElementById('history-modal').style.display = 'flex';
        }

        // Ø¨Ø§Ø²ÛŒØ§Ø¨ÛŒ ÙØ§Ú©ØªÙˆØ± Ø§Ø² ØªØ§Ø±ÛŒØ®Ú†Ù‡
        function restoreInvoice(invoiceId) {
            const invoices = JSON.parse(localStorage.getItem('invoices')) || [];
            const invoice = invoices.find(inv => inv.id === invoiceId);
            
            if (invoice) {
                currentInvoice = invoice;
                displayInvoicePreview(invoice);
                document.getElementById('invoice-actions').style.display = 'block';
                
                // Ù¾Ø± Ú©Ø±Ø¯Ù† ÙØ±Ù… Ø¨Ø§ Ø§Ø·Ù„Ø§Ø¹Ø§Øª ÙØ§Ú©ØªÙˆØ±
                document.getElementById('invoice-type').value = invoice.type;
                document.getElementById('invoice-number').value = invoice.number;
                document.getElementById('invoice-date').value = invoice.date;
                document.getElementById('invoice-due-date').value = invoice.dueDate || '';
                document.getElementById('invoice-seller').value = invoice.seller.name;
                document.getElementById('seller-tax-id').value = invoice.seller.taxId || '';
                document.getElementById('seller-address').value = invoice.seller.address || '';
                document.getElementById('seller-phone').value = invoice.seller.phone || '';
                document.getElementById('invoice-buyer').value = invoice.buyer.name;
                document.getElementById('buyer-tax-id').value = invoice.buyer.taxId || '';
                document.getElementById('buyer-address').value = invoice.buyer.address || '';
                document.getElementById('payment-terms').value = invoice.paymentTerms || 'cash';
                document.getElementById('invoice-notes').value = invoice.notes || '';
                
                // Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† Ø§Ù‚Ù„Ø§Ù… ÙØ¹Ù„ÛŒ
                document.getElementById('invoice-items').innerHTML = '';
                
                // Ø§ÙØ²ÙˆØ¯Ù† Ø§Ù‚Ù„Ø§Ù… ÙØ§Ú©ØªÙˆØ±
                invoice.items.forEach(item => {
                    addInvoiceItem();
                    const rows = document.querySelectorAll('.invoice-item-row');
                    const lastRow = rows[rows.length - 1];
                    
                    lastRow.querySelector('.item-name').value = item.name;
                    lastRow.querySelector('.item-quantity').value = item.quantity;
                    lastRow.querySelector('.item-price').value = item.price;
                    lastRow.querySelector('.item-discount').value = item.discount;
                    lastRow.querySelector('.item-description').value = item.description || '';
                });
                
                // Ø§Ú¯Ø± Ø§Ù…Ø¶Ø§ ÙˆØ¬ÙˆØ¯ Ø¯Ø§Ø±Ø¯ØŒ Ù†Ù…Ø§ÛŒØ´ Ø¢Ù†
                if (invoice.sellerSignature && sellerSignaturePad) {
                    // Ø¯Ø± ÛŒÚ© Ø³ÛŒØ³ØªÙ… ÙˆØ§Ù‚Ø¹ÛŒØŒ Ø§ÛŒÙ†Ø¬Ø§ Ø§Ù…Ø¶Ø§ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù…ÛŒâ€ŒØ´ÙˆØ¯
                    showSuccessMessage('ÙØ§Ú©ØªÙˆØ± Ø¨Ø§Ø²ÛŒØ§Ø¨ÛŒ Ø´Ø¯');
                }
                
                closeModal('history-modal');
                showSuccessMessage('ÙØ§Ú©ØªÙˆØ± Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø¨Ø§Ø²ÛŒØ§Ø¨ÛŒ Ø´Ø¯');
                
                // Ø§Ø³Ú©Ø±ÙˆÙ„ Ø¨Ù‡ Ø¨Ø§Ù„Ø§ÛŒ ÙØ±Ù…
                document.querySelector('.form-container').scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
        }

        // Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† ØªØ§Ø±ÛŒØ®Ú†Ù‡
        function clearHistory() {
            if (confirm('Ø¢ÛŒØ§ Ø§Ø² Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† ØªÙ…Ø§Ù… ØªØ§Ø±ÛŒØ®Ú†Ù‡ ÙØ§Ú©ØªÙˆØ±Ù‡Ø§ Ø§Ø·Ù…ÛŒÙ†Ø§Ù† Ø¯Ø§Ø±ÛŒØ¯ØŸ Ø§ÛŒÙ† Ø¹Ù…Ù„ Ù‚Ø§Ø¨Ù„ Ø¨Ø§Ø²Ú¯Ø´Øª Ù†ÛŒØ³Øª.')) {
                localStorage.removeItem('invoices');
                showSuccessMessage('ØªØ§Ø±ÛŒØ®Ú†Ù‡ ÙØ§Ú©ØªÙˆØ±Ù‡Ø§ Ù¾Ø§Ú© Ø´Ø¯');
                closeModal('history-modal');
            }
        }

        // Ø°Ø®ÛŒØ±Ù‡ Ù‚Ø§Ù„Ø¨ ÙØ§Ú©ØªÙˆØ±
        function saveInvoiceTemplate() {
            const template = {
                seller: document.getElementById('invoice-seller').value,
                sellerTaxId: document.getElementById('seller-tax-id').value,
                sellerAddress: document.getElementById('seller-address').value,
                sellerPhone: document.getElementById('seller-phone').value,
                paymentTerms: document.getElementById('payment-terms').value
            };
            
            localStorage.setItem('invoiceTemplate', JSON.stringify(template));
            showSuccessMessage('Ù‚Ø§Ù„Ø¨ ÙØ§Ú©ØªÙˆØ± Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯');
        }

        // Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù‚Ø§Ù„Ø¨â€ŒÙ‡Ø§ÛŒ ÙØ§Ú©ØªÙˆØ±
        function loadInvoiceTemplates() {
            const template = JSON.parse(localStorage.getItem('invoiceTemplate'));
            if (template) {
                document.getElementById('invoice-seller').value = template.seller || '';
                document.getElementById('seller-tax-id').value = template.sellerTaxId || '';
                document.getElementById('seller-address').value = template.sellerAddress || '';
                document.getElementById('seller-phone').value = template.sellerPhone || '';
                document.getElementById('payment-terms').value = template.paymentTerms || 'cash';
            }
        }

        // Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† ÙØ±Ù…
        function clearInvoiceForm() {
            if (confirm('Ø¢ÛŒØ§ Ø§Ø² Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† ØªÙ…Ø§Ù… Ø§Ø·Ù„Ø§Ø¹Ø§Øª ÙØ±Ù… Ø§Ø·Ù…ÛŒÙ†Ø§Ù† Ø¯Ø§Ø±ÛŒØ¯ØŸ')) {
                document.getElementById('invoice-items').innerHTML = '';
                document.getElementById('invoice-buyer').value = '';
                document.getElementById('buyer-tax-id').value = '';
                document.getElementById('buyer-address').value = '';
                document.getElementById('invoice-notes').value = '';
                document.getElementById('seller-stamp').value = '';
                clearSellerSignature();
                
                // Ø¨Ø§Ø²Ù†Ø´Ø§Ù†ÛŒ Ø´Ù…Ø§Ø±Ù‡ ÙØ§Ú©ØªÙˆØ±
                invoiceCounter = parseInt(localStorage.getItem('invoiceCounter')) || 1;
                document.getElementById('invoice-number').value = `FA-1403-${invoiceCounter.toString().padStart(3, '0')}`;
                
                // Ø§ÙØ²ÙˆØ¯Ù† ÛŒÚ© Ø¢ÛŒØªÙ… Ø®Ø§Ù„ÛŒ
                addInvoiceItem();
                
                // Ù¾Ù†Ù‡Ø§Ù† Ú©Ø±Ø¯Ù† Ù¾ÛŒØ´â€ŒÙ†Ù…Ø§ÛŒØ´ Ùˆ Ø§Ù‚Ø¯Ø§Ù…Ø§Øª
                document.getElementById('invoice-preview').style.display = 'none';
                document.getElementById('invoice-actions').style.display = 'none';
                currentInvoice = null;
                
                showSuccessMessage('ÙØ±Ù… Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ù¾Ø§Ú© Ø´Ø¯');
            }
        }

        // Ø¨Ø³ØªÙ† Ù…ÙˆØ¯Ø§Ù„
        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        // ÙØ±Ù…Øª ØªØ§Ø±ÛŒØ®
        function formatDate(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString);
            return date.toLocaleDateString('fa-IR');
        }

        // ÙØ±Ù…Øª Ø¹Ø¯Ø¯
        function formatNumber(num) {
            return num.toLocaleString();
        }

        // Ù†Ù…Ø§ÛŒØ´ Ù¾ÛŒØ§Ù… Ù…ÙˆÙÙ‚ÛŒØª
        function showSuccessMessage(message) {
            const existingMessage = document.querySelector('.success-message');
            if (existingMessage) {
                existingMessage.remove();
            }
            
            const successMessage = document.createElement('div');
            successMessage.className = 'success-message';
            successMessage.innerHTML = `
                <div style="display: flex; align-items: center; justify-content: center; gap: 10px;">
                    <i class="fas fa-check-circle"></i>
                    <span>${message}</span>
                </div>
            `;
            
            const mainContent = document.querySelector('.main-content');
            mainContent.insertBefore(successMessage, mainContent.firstChild);
            
            setTimeout(() => {
                if (successMessage.parentElement) {
                    successMessage.remove();
                }
            }, 3000);
        }
    </script>
</body>
</html>