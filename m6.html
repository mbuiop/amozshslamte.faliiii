<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø³ÛŒØ³ØªÙ… Ø§ÛŒØ¬Ø§Ø¯ ÙØ§Ú©ØªÙˆØ± Ø­Ø±ÙÙ‡â€ŒØ§ÛŒ</title>
    <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.0.0/dist/signature_pad.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        :root {
            --primary: #27ae60;
            --primary-dark: #219653;
            --secondary: #3498db;
            --danger: #e74c3c;
            --warning: #f39c12;
            --dark: #2c3e50;
            --light: #ecf0f1;
            --success: #2ecc71;
            --purple: #9b59b6;
            --teal: #1abc9c;
            --gold: #f1c40f;
            --orange: #e67e22;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 0;
            color: #333;
            overflow-x: hidden;
        }

        .container {
            max-width: 100%;
            margin: 0 auto;
            background: white;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            box-shadow: 0 0 50px rgba(0, 0, 0, 0.2);
        }

        .top-header {
            background: linear-gradient(135deg, var(--dark), #34495e);
            color: white;
            padding: 10px 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .logo-icon {
            font-size: 1.3em;
        }

        .logo-text {
            font-size: 0.9em;
            font-weight: 800;
        }

        .header-btn {
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border: none;
            padding: 6px 10px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.8em;
            font-weight: 600;
            transition: all 0.3s ease;
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 4px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }

        .header-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        }

        .main-content {
            flex: 1;
            padding: 12px;
            overflow-y: auto;
            padding-bottom: 20px;
        }

        .form-container {
            background: white;
            border-radius: 12px;
            padding: 15px;
            box-shadow: 0 3px 15px rgba(0, 0, 0, 0.1);
            margin-bottom: 15px;
            border: 1px solid #e0e0e0;
            position: relative;
            overflow: hidden;
        }

        .form-container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, var(--primary), var(--secondary), var(--purple));
        }

        .form-title {
            font-size: 1.1em;
            font-weight: 800;
            margin-bottom: 15px;
            color: var(--dark);
            text-align: center;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--primary);
        }

        .form-group {
            margin-bottom: 12px;
        }

        label {
            display: block;
            margin-bottom: 6px;
            font-weight: 700;
            color: var(--dark);
            font-size: 0.8em;
        }

        input, select, textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            font-size: 12px;
            transition: all 0.3s;
            background: #fafafa;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--primary);
            background: white;
            box-shadow: 0 0 0 2px rgba(39, 174, 96, 0.1);
        }

        .btn {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 800;
            transition: all 0.3s;
            width: 100%;
            box-shadow: 0 3px 12px rgba(39, 174, 96, 0.4);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }

        .btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 15px rgba(39, 174, 96, 0.6);
        }

        .btn-purple {
            background: linear-gradient(135deg, var(--purple), #8e44ad);
            box-shadow: 0 3px 12px rgba(155, 89, 182, 0.4);
        }

        .btn-warning {
            background: linear-gradient(135deg, var(--warning), #e67e22);
            box-shadow: 0 3px 12px rgba(243, 156, 18, 0.4);
        }

        .btn-danger {
            background: linear-gradient(135deg, var(--danger), #c0392b);
            box-shadow: 0 3px 12px rgba(231, 76, 60, 0.4);
        }

        .add-cost-btn {
            background: var(--secondary);
            color: white;
            border: none;
            padding: 6px 10px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.75em;
            display: flex;
            align-items: center;
            gap: 4px;
            transition: all 0.3s;
        }

        .add-cost-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 6px rgba(52, 152, 219, 0.4);
        }

        .add-cost-btn.danger {
            background: var(--danger);
        }

        .signature-pad {
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            background: white;
            margin-bottom: 12px;
            height: 150px;
            width: 100%;
        }

        .invoice-preview {
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
            box-shadow: 0 3px 15px rgba(0, 0, 0, 0.1);
        }

        .invoice-header {
            text-align: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--primary);
        }

        .invoice-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 15px;
        }

        .invoice-items {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 15px;
            font-size: 0.8em;
        }

        .invoice-items th, .invoice-items td {
            border: 1px solid #e0e0e0;
            padding: 8px;
            text-align: center;
        }

        .invoice-items th {
            background: #f5f5f5;
            font-weight: 700;
        }

        .invoice-total {
            text-align: left;
            font-weight: 800;
            font-size: 1.1em;
            margin-top: 10px;
        }

        .invoice-signatures {
            display: flex;
            justify-content: space-between;
            margin-top: 30px;
        }

        .signature-box {
            text-align: center;
            width: 45%;
        }

        .signature-line {
            border-top: 1px solid #333;
            margin-top: 40px;
            padding-top: 5px;
        }

        .success-message {
            background: var(--success);
            color: white;
            padding: 12px;
            border-radius: 8px;
            text-align: center;
            margin: 12px 0;
            font-weight: 700;
            box-shadow: 0 3px 12px rgba(46, 204, 113, 0.5);
            animation: slideIn 0.5s ease-out;
            font-size: 0.8em;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateY(-8px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .info-message {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            padding: 15px;
            border-radius: 10px;
            margin: 12px 0;
            box-shadow: 0 4px 12px rgba(52, 152, 219, 0.4);
            text-align: center;
            border: 1px solid white;
        }

        .info-title {
            font-size: 1em;
            font-weight: 800;
            margin-bottom: 8px;
        }

        .info-content {
            font-size: 0.85em;
            line-height: 1.4;
            opacity: 0.95;
        }

        .tax-calculations {
            background: #f8f9fa;
            padding: 12px;
            border-radius: 8px;
            margin: 10px 0;
            border-right: 2px solid var(--primary);
        }

        .tax-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            font-size: 0.8em;
        }

        .invoice-item-row {
            margin-bottom: 8px;
            padding: 8px;
            background: #f8f9fa;
            border-radius: 6px;
        }

        @media (min-width: 768px) {
            .container {
                max-width: 800px;
                margin: 15px auto;
                min-height: calc(100vh - 30px);
                border-radius: 15px;
                overflow: hidden;
            }
        }

        @media print {
            .no-print {
                display: none !important;
            }
            .invoice-preview {
                box-shadow: none;
                border: 1px solid #000;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="top-header">
            <div class="logo">
                <div class="logo-icon">ğŸ§¾</div>
                <div class="logo-text">Ø³ÛŒØ³ØªÙ… Ø§ÛŒØ¬Ø§Ø¯ ÙØ§Ú©ØªÙˆØ± Ø­Ø±ÙÙ‡â€ŒØ§ÛŒ</div>
            </div>
            <a href="index.html" class="header-btn">ğŸ”™ Ø¨Ø§Ø²Ú¯Ø´Øª</a>
        </div>

        <div class="main-content">
            <div class="form-container">
                <h2 class="form-title">ğŸ§¾ Ø§ÛŒØ¬Ø§Ø¯ ÙØ§Ú©ØªÙˆØ± Ø¬Ø¯ÛŒØ¯</h2>
                
                <div class="form-group">
                    <label for="invoice-type">Ù†ÙˆØ¹ ÙØ§Ú©ØªÙˆØ±:</label>
                    <select id="invoice-type">
                        <option value="sale">ÙØ±ÙˆØ´</option>
                        <option value="purchase">Ø®Ø±ÛŒØ¯</option>
                        <option value="proforma">Ù¾ÛŒØ´â€ŒÙØ§Ú©ØªÙˆØ±</option>
                        <option value="return">Ø¨Ø±Ú¯Ø´Øª Ø§Ø² ÙØ±ÙˆØ´</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="invoice-number">Ø´Ù…Ø§Ø±Ù‡ ÙØ§Ú©ØªÙˆØ±:</label>
                    <input type="text" id="invoice-number" placeholder="Ø´Ù…Ø§Ø±Ù‡ ÙØ§Ú©ØªÙˆØ± (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)" value="FA-1403-001">
                </div>

                <div class="form-group">
                    <label for="invoice-date">ØªØ§Ø±ÛŒØ® ÙØ§Ú©ØªÙˆØ±:</label>
                    <input type="date" id="invoice-date">
                </div>

                <div class="form-group">
                    <label for="invoice-due-date">ØªØ§Ø±ÛŒØ® Ø³Ø±Ø±Ø³ÛŒØ¯:</label>
                    <input type="date" id="invoice-due-date">
                </div>

                <div class="form-group">
                    <label for="invoice-seller">ÙØ±ÙˆØ´Ù†Ø¯Ù‡:</label>
                    <input type="text" id="invoice-seller" placeholder="Ù†Ø§Ù… ÙØ±ÙˆØ´Ù†Ø¯Ù‡ / Ø´Ø±Ú©Øª" value="Ø´Ø±Ú©Øª Ù†Ù…ÙˆÙ†Ù‡ ØªØ¬Ø§Ø±Øª">
                </div>

                <div class="form-group">
                    <label for="seller-tax-id">Ø´Ù†Ø§Ø³Ù‡ Ù…Ù„ÛŒ/Ú©Ø¯ Ø§Ù‚ØªØµØ§Ø¯ÛŒ ÙØ±ÙˆØ´Ù†Ø¯Ù‡:</label>
                    <input type="text" id="seller-tax-id" placeholder="Ú©Ø¯ Ø§Ù‚ØªØµØ§Ø¯ÛŒ ÙØ±ÙˆØ´Ù†Ø¯Ù‡" value="12345678901">
                </div>

                <div class="form-group">
                    <label for="seller-address">Ø¢Ø¯Ø±Ø³ ÙØ±ÙˆØ´Ù†Ø¯Ù‡:</label>
                    <textarea id="seller-address" rows="2" placeholder="Ø¢Ø¯Ø±Ø³ Ú©Ø§Ù…Ù„ ÙØ±ÙˆØ´Ù†Ø¯Ù‡">ØªÙ‡Ø±Ø§Ù†ØŒ Ø®ÛŒØ§Ø¨Ø§Ù† Ù†Ù…ÙˆÙ†Ù‡ØŒ Ù¾Ù„Ø§Ú© Û±Û²Û³</textarea>
                </div>

                <div class="form-group">
                    <label for="seller-phone">ØªÙ„ÙÙ† ÙØ±ÙˆØ´Ù†Ø¯Ù‡:</label>
                    <input type="text" id="seller-phone" placeholder="Ø´Ù…Ø§Ø±Ù‡ ØªÙ…Ø§Ø³ ÙØ±ÙˆØ´Ù†Ø¯Ù‡" value="021-12345678">
                </div>

                <div class="form-group">
                    <label for="invoice-buyer">Ø®Ø±ÛŒØ¯Ø§Ø±:</label>
                    <input type="text" id="invoice-buyer" placeholder="Ù†Ø§Ù… Ø®Ø±ÛŒØ¯Ø§Ø± / Ø´Ø±Ú©Øª" value="Ø´Ø±Ú©Øª Ú©Ø§Ù„Ø§ÛŒ Ø¨Ø±ØªØ±">
                </div>

                <div class="form-group">
                    <label for="buyer-tax-id">Ø´Ù†Ø§Ø³Ù‡ Ù…Ù„ÛŒ/Ú©Ø¯ Ø§Ù‚ØªØµØ§Ø¯ÛŒ Ø®Ø±ÛŒØ¯Ø§Ø±:</label>
                    <input type="text" id="buyer-tax-id" placeholder="Ú©Ø¯ Ø§Ù‚ØªØµØ§Ø¯ÛŒ Ø®Ø±ÛŒØ¯Ø§Ø±" value="98765432109">
                </div>

                <div class="form-group">
                    <label for="buyer-address">Ø¢Ø¯Ø±Ø³ Ø®Ø±ÛŒØ¯Ø§Ø±:</label>
                    <textarea id="buyer-address" rows="2" placeholder="Ø¢Ø¯Ø±Ø³ Ú©Ø§Ù…Ù„ Ø®Ø±ÛŒØ¯Ø§Ø±">Ø§ØµÙÙ‡Ø§Ù†ØŒ Ø®ÛŒØ§Ø¨Ø§Ù† Ù…Ø±Ú©Ø²ÛŒØŒ Ù¾Ù„Ø§Ú© Û´ÛµÛ¶</textarea>
                </div>

                <h3 style="margin: 20px 0 10px; color: var(--dark);">ğŸ›ï¸ Ø§Ù‚Ù„Ø§Ù… ÙØ§Ú©ØªÙˆØ±</h3>
                
                <div id="invoice-items">
                    <div class="invoice-item-row">
                        <div style="display: grid; grid-template-columns: 2fr 1fr 1fr 1fr auto; gap: 8px; margin-bottom: 8px; align-items: center;">
                            <input type="text" placeholder="Ù†Ø§Ù… Ú©Ø§Ù„Ø§ / Ø®Ø¯Ù…Øª" class="item-name" value="Ù„Ù¾â€ŒØªØ§Ù¾ ØªØ¬Ø§Ø±ÛŒ">
                            <input type="number" placeholder="ØªØ¹Ø¯Ø§Ø¯" class="item-quantity" value="2" min="1">
                            <input type="number" placeholder="Ù‚ÛŒÙ…Øª ÙˆØ§Ø­Ø¯" class="item-price" value="25000000">
                            <input type="number" placeholder="ØªØ®ÙÛŒÙ %" class="item-discount" value="5" min="0" max="100">
                            <button type="button" class="add-cost-btn danger" onclick="removeInvoiceItem(this)">âœ•</button>
                        </div>
                        <textarea class="item-description" placeholder="ØªÙˆØ¶ÛŒØ­Ø§Øª Ú©Ø§Ù„Ø§ (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)" rows="2" style="width: 100%; margin-top: 5px; font-size: 0.8em;">Ù„Ù¾â€ŒØªØ§Ù¾ Û±Ûµ Ø§ÛŒÙ†Ú†ÛŒØŒ Core i7ØŒ 16GB RAM</textarea>
                    </div>
                </div>

                <button type="button" class="add-cost-btn" onclick="addInvoiceItem()" style="margin-bottom: 15px;">
                    <span>â•</span> Ø§ÙØ²ÙˆØ¯Ù† Ú©Ø§Ù„Ø§ÛŒ Ø¬Ø¯ÛŒØ¯
                </button>

                <div class="form-group">
                    <label for="payment-terms">Ø´Ø±Ø§ÛŒØ· Ù¾Ø±Ø¯Ø§Ø®Øª:</label>
                    <select id="payment-terms">
                        <option value="cash">Ù†Ù‚Ø¯ÛŒ</option>
                        <option value="check">Ú†Ú©</option>
                        <option value="installment">Ø§Ù‚Ø³Ø§Ø·</option>
                        <option value="transfer">Ú©Ø§Ø±Øª Ø¨Ù‡ Ú©Ø§Ø±Øª</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="invoice-notes">ØªÙˆØ¶ÛŒØ­Ø§Øª Ùˆ Ø´Ø±Ø§ÛŒØ·:</label>
                    <textarea id="invoice-notes" rows="3" placeholder="ØªÙˆØ¶ÛŒØ­Ø§Øª Ø§Ø¶Ø§ÙÛŒØŒ Ø´Ø±Ø§ÛŒØ· Ú¯Ø§Ø±Ø§Ù†ØªÛŒØŒ Ù†Ø­ÙˆÙ‡ ØªØ­ÙˆÛŒÙ„ Ùˆ ...">Ú©Ø§Ù„Ø§Ù‡Ø§ Ø¸Ø±Ù Û³ Ø±ÙˆØ² Ú©Ø§Ø±ÛŒ Ø¢Ù…Ø§Ø¯Ù‡ ØªØ­ÙˆÛŒÙ„ Ù…ÛŒâ€ŒØ¨Ø§Ø´Ø¯. Ú¯Ø§Ø±Ø§Ù†ØªÛŒ Û±Û¸ Ù…Ø§Ù‡Ù‡</textarea>
                </div>

                <h3 style="margin: 20px 0 10px; color: var(--dark);">âœï¸ Ø§Ù…Ø¶Ø§Ù‡Ø§</h3>
                
                <div class="signature-pad-container">
                    <label>Ø§Ù…Ø¶Ø§ÛŒ ÙØ±ÙˆØ´Ù†Ø¯Ù‡:</label>
                    <canvas class="signature-pad" id="seller-signature-pad"></canvas>
                    <div style="display: flex; gap: 8px; margin-bottom: 15px;">
                        <button type="button" class="add-cost-btn danger" onclick="clearSellerSignature()">
                            <span>ğŸ—‘ï¸</span> Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† Ø§Ù…Ø¶Ø§
                        </button>
                        <button type="button" class="add-cost-btn" onclick="loadSampleSignature()">
                            <span>ğŸ“</span> Ø§Ù…Ø¶Ø§ÛŒ Ù†Ù…ÙˆÙ†Ù‡
                        </button>
                    </div>
                </div>

                <div class="form-group">
                    <label for="seller-stamp">Ù…Ù‡Ø± ÙØ±ÙˆØ´Ù†Ø¯Ù‡ (URL ØªØµÙˆÛŒØ±):</label>
                    <input type="text" id="seller-stamp" placeholder="Ø¢Ø¯Ø±Ø³ ØªØµÙˆÛŒØ± Ù…Ù‡Ø± Ø´Ø±Ú©Øª (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)">
                </div>

                <button class="btn btn-purple" onclick="generateInvoice()">
                    <span>ğŸ§¾</span> Ø§ÛŒØ¬Ø§Ø¯ Ùˆ Ù¾ÛŒØ´â€ŒÙ†Ù…Ø§ÛŒØ´ ÙØ§Ú©ØªÙˆØ±
                </button>

                <button class="btn btn-warning no-print" onclick="saveInvoiceTemplate()" style="margin-top: 10px;">
                    <span>ğŸ’¾</span> Ø°Ø®ÛŒØ±Ù‡ Ù‚Ø§Ù„Ø¨ ÙØ§Ú©ØªÙˆØ±
                </button>

                <button class="btn btn-danger no-print" onclick="clearInvoiceForm()" style="margin-top: 10px;">
                    <span>ğŸ—‘ï¸</span> Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† ÙØ±Ù…
                </button>
            </div>

            <div class="invoice-preview no-print" id="invoice-preview" style="display: none;">
                <!-- Ù¾ÛŒØ´â€ŒÙ†Ù…Ø§ÛŒØ´ ÙØ§Ú©ØªÙˆØ± Ø¯Ø± Ø§ÛŒÙ†Ø¬Ø§ Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯ -->
            </div>

            <div class="form-container no-print" id="invoice-actions" style="display: none;">
                <h2 class="form-title">ğŸ“¥ Ø§Ù‚Ø¯Ø§Ù…Ø§Øª ÙØ§Ú©ØªÙˆØ±</h2>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                    <button class="btn" onclick="downloadInvoiceAsPDF()">
                        <span>ğŸ“¥</span> Ø¯Ø§Ù†Ù„ÙˆØ¯ PDF
                    </button>
                    <button class="btn btn-purple" onclick="printInvoice()">
                        <span>ğŸ–¨ï¸</span> Ú†Ø§Ù¾ ÙØ§Ú©ØªÙˆØ±
                    </button>
                    <button class="btn btn-warning" onclick="sendInvoiceByEmail()">
                        <span>ğŸ“§</span> Ø§Ø±Ø³Ø§Ù„ Ø§ÛŒÙ…ÛŒÙ„
                    </button>
                    <button class="btn" onclick="saveInvoiceToHistory()">
                        <span>ğŸ’¾</span> Ø°Ø®ÛŒØ±Ù‡ Ø¯Ø± ØªØ§Ø±ÛŒØ®Ú†Ù‡
                    </button>
                </div>
            </div>

            <div class="form-container no-print">
                <h2 class="form-title">ğŸ’¡ Ø±Ø§Ù‡Ù†Ù…Ø§ÛŒ Ø§ÛŒØ¬Ø§Ø¯ ÙØ§Ú©ØªÙˆØ±</h2>
                <div class="info-message">
                    <div class="info-title">Ù†Ú©Ø§Øª Ù…Ù‡Ù… Ø¨Ø±Ø§ÛŒ ÙØ§Ú©ØªÙˆØ±Ù‡Ø§ÛŒ Ù…Ø¹ØªØ¨Ø±</div>
                    <div class="info-content">
                        â€¢ Ø´Ù…Ø§Ø±Ù‡ ÙØ§Ú©ØªÙˆØ± Ø¨Ø§ÛŒØ¯ Ù…Ù†Ø­ØµØ± Ø¨Ù‡ ÙØ±Ø¯ Ø¨Ø§Ø´Ø¯<br>
                        â€¢ Ø§Ø·Ù„Ø§Ø¹Ø§Øª ÙØ±ÙˆØ´Ù†Ø¯Ù‡ Ùˆ Ø®Ø±ÛŒØ¯Ø§Ø± Ø¨Ø§ÛŒØ¯ Ú©Ø§Ù…Ù„ Ø¨Ø§Ø´Ø¯<br>
                        â€¢ Ø¨Ø±Ø§ÛŒ ÙØ§Ú©ØªÙˆØ±Ù‡Ø§ÛŒ Ø¨Ø§Ù„Ø§ÛŒ Û±Û° Ù…ÛŒÙ„ÛŒÙˆÙ† Ø§Ù…Ø¶Ø§ Ø§Ù„Ø²Ø§Ù…ÛŒ Ø§Ø³Øª<br>
                        â€¢ ÙØ§Ú©ØªÙˆØ±Ù‡Ø§ Ø¨Ù‡ Ù…Ø¯Øª Û±Û° Ø³Ø§Ù„ Ø¨Ø§ÛŒØ¯ archiv Ø´ÙˆÙ†Ø¯
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Ù…ØªØºÛŒØ±Ù‡Ø§ÛŒ Ø³ÛŒØ³ØªÙ…
        let sellerSignaturePad = null;
        let currentInvoice = null;
        let invoiceCounter = parseInt(localStorage.getItem('invoiceCounter')) || 1;

        // Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø§ÙˆÙ„ÛŒÙ‡
        window.onload = function() {
            initializeSignaturePad();
            setDefaultDates();
            loadInvoiceTemplates();
        };

        // ØªÙ†Ø¸ÛŒÙ… ØªØ§Ø±ÛŒØ®â€ŒÙ‡Ø§ÛŒ Ù¾ÛŒØ´â€ŒÙØ±Ø¶
        function setDefaultDates() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('invoice-date').value = today;
            
            // ØªØ§Ø±ÛŒØ® Ø³Ø±Ø±Ø³ÛŒØ¯ Û· Ø±ÙˆØ² Ø¨Ø¹Ø¯
            const dueDate = new Date();
            dueDate.setDate(dueDate.getDate() + 7);
            document.getElementById('invoice-due-date').value = dueDate.toISOString().split('T')[0];
        }

        // Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ Ù¾Ø¯ Ø§Ù…Ø¶Ø§
        function initializeSignaturePad() {
            const canvas = document.getElementById('seller-signature-pad');
            if (canvas) {
                sellerSignaturePad = new SignaturePad(canvas, {
                    backgroundColor: 'white',
                    penColor: 'rgb(0, 0, 0)',
                    minWidth: 1,
                    maxWidth: 3
                });
                
                // ØªÙ†Ø¸ÛŒÙ… Ø³Ø§ÛŒØ² Ú©Ø§Ù†ÙˆØ§Ø³
                canvas.style.width = '100%';
                canvas.style.height = '150px';
            }
        }

        // Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† Ø§Ù…Ø¶Ø§ÛŒ ÙØ±ÙˆØ´Ù†Ø¯Ù‡
        function clearSellerSignature() {
            if (sellerSignaturePad) {
                sellerSignaturePad.clear();
            }
        }

        // Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø§Ù…Ø¶Ø§ÛŒ Ù†Ù…ÙˆÙ†Ù‡
        function loadSampleSignature() {
            if (sellerSignaturePad) {
                // Ø¯Ø± ÛŒÚ© Ø³ÛŒØ³ØªÙ… ÙˆØ§Ù‚Ø¹ÛŒØŒ Ø§ÛŒÙ†Ø¬Ø§ Ø§Ù…Ø¶Ø§ÛŒ Ø§Ø² Ù¾ÛŒØ´ Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯Ù‡ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù…ÛŒâ€ŒØ´ÙˆØ¯
                showSuccessMessage('Ø§Ù…Ø¶Ø§ÛŒ Ù†Ù…ÙˆÙ†Ù‡ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø´Ø¯ (Ø¯Ø± Ù†Ø³Ø®Ù‡ ÙˆØ§Ù‚Ø¹ÛŒØŒ Ø§Ù…Ø¶Ø§ÛŒ Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯Ù‡ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù…ÛŒâ€ŒØ´ÙˆØ¯)');
            }
        }

        // Ø§ÙØ²ÙˆØ¯Ù† Ø¢ÛŒØªÙ… Ø¬Ø¯ÛŒØ¯ Ø¨Ù‡ ÙØ§Ú©ØªÙˆØ±
        function addInvoiceItem() {
            const itemsContainer = document.getElementById('invoice-items');
            const itemRow = document.createElement('div');
            itemRow.className = 'invoice-item-row';
            itemRow.innerHTML = `
                <div style="display: grid; grid-template-columns: 2fr 1fr 1fr 1fr auto; gap: 8px; margin-bottom: 8px; align-items: center;">
                    <input type="text" placeholder="Ù†Ø§Ù… Ú©Ø§Ù„Ø§ / Ø®Ø¯Ù…Øª" class="item-name">
                    <input type="number" placeholder="ØªØ¹Ø¯Ø§Ø¯" class="item-quantity" value="1" min="1">
                    <input type="number" placeholder="Ù‚ÛŒÙ…Øª ÙˆØ§Ø­Ø¯" class="item-price">
                    <input type="number" placeholder="ØªØ®ÙÛŒÙ %" class="item-discount" value="0" min="0" max="100">
                    <button type="button" class="add-cost-btn danger" onclick="removeInvoiceItem(this)">âœ•</button>
                </div>
                <textarea class="item-description" placeholder="ØªÙˆØ¶ÛŒØ­Ø§Øª Ú©Ø§Ù„Ø§ (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)" rows="2" style="width: 100%; margin-top: 5px; font-size: 0.8em;"></textarea>
            `;
            itemsContainer.appendChild(itemRow);
        }

        // Ø­Ø°Ù Ø¢ÛŒØªÙ… Ø§Ø² ÙØ§Ú©ØªÙˆØ±
        function removeInvoiceItem(button) {
            if (document.querySelectorAll('.invoice-item-row').length > 1) {
                button.closest('.invoice-item-row').remove();
            } else {
                alert('ÙØ§Ú©ØªÙˆØ± Ø¨Ø§ÛŒØ¯ Ø­Ø¯Ø§Ù‚Ù„ ÛŒÚ© Ø¢ÛŒØªÙ… Ø¯Ø§Ø´ØªÙ‡ Ø¨Ø§Ø´Ø¯');
            }
        }

        // ØªÙˆÙ„ÛŒØ¯ ÙØ§Ú©ØªÙˆØ±
        function generateInvoice() {
            // Ø¬Ù…Ø¹â€ŒØ¢ÙˆØ±ÛŒ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ù¾Ø§ÛŒÙ‡
            const type = document.getElementById('invoice-type').value;
            const number = document.getElementById('invoice-number').value || `FA-1403-${invoiceCounter.toString().padStart(3, '0')}`;
            const date = document.getElementById('invoice-date').value;
            const dueDate = document.getElementById('invoice-due-date').value;
            const seller = document.getElementById('invoice-seller').value;
            const sellerTaxId = document.getElementById('seller-tax-id').value;
            const sellerAddress = document.getElementById('seller-address').value;
            const sellerPhone = document.getElementById('seller-phone').value;
            const buyer = document.getElementById('invoice-buyer').value;
            const buyerTaxId = document.getElementById('buyer-tax-id').value;
            const buyerAddress = document.getElementById('buyer-address').value;
            const paymentTerms = document.getElementById('payment-terms').value;
            const notes = document.getElementById('invoice-notes').value;

            if (!seller || !buyer) {
                alert('Ù„Ø·ÙØ§Ù‹ Ø§Ø·Ù„Ø§Ø¹Ø§Øª ÙØ±ÙˆØ´Ù†Ø¯Ù‡ Ùˆ Ø®Ø±ÛŒØ¯Ø§Ø± Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯');
                return;
            }

            // Ø¬Ù…Ø¹â€ŒØ¢ÙˆØ±ÛŒ Ø¢ÛŒØªÙ…â€ŒÙ‡Ø§
            const items = [];
            let subtotal = 0;
            let totalDiscount = 0;
            
            document.querySelectorAll('.invoice-item-row').forEach(row => {
                const name = row.querySelector('.item-name').value;
                const quantity = parseInt(row.querySelector('.item-quantity').value) || 0;
                const price = parseInt(row.querySelector('.item-price').value) || 0;
                const discount = parseInt(row.querySelector('.item-discount').value) || 0;
                const description = row.querySelector('.item-description').value;

                if (name && quantity > 0 && price > 0) {
                    const itemTotal = quantity * price;
                    const itemDiscount = (itemTotal * discount) / 100;
                    const itemNet = itemTotal - itemDiscount;
                    
                    subtotal += itemTotal;
                    totalDiscount += itemDiscount;
                    
                    items.push({
                        name,
                        quantity,
                        price,
                        discount,
                        description,
                        total: itemTotal,
                        discountAmount: itemDiscount,
                        net: itemNet
                    });
                }
            });

            if (items.length === 0) {
                alert('Ù„Ø·ÙØ§Ù‹ Ø­Ø¯Ø§Ù‚Ù„ ÛŒÚ© Ú©Ø§Ù„Ø§ Ø¨Ù‡ ÙØ§Ú©ØªÙˆØ± Ø§Ø¶Ø§ÙÙ‡ Ú©Ù†ÛŒØ¯');
                return;
            }

            // Ù…Ø­Ø§Ø³Ø¨Ø§Øª Ù…Ø§Ù„ÛŒØ§ØªÛŒ
            const taxRate = 9; // 9% Ù…Ø§Ù„ÛŒØ§Øª Ø¨Ø± Ø§Ø±Ø²Ø´ Ø§ÙØ²ÙˆØ¯Ù‡
            const taxAmount = (subtotal - totalDiscount) * taxRate / 100;
            const totalAmount = subtotal - totalDiscount + taxAmount;

            // Ø§Ù…Ø¶Ø§
            let sellerSignature = null;
            if (sellerSignaturePad && !sellerSignaturePad.isEmpty()) {
                sellerSignature = sellerSignaturePad.toDataURL();
            }

            // Ø°Ø®ÛŒØ±Ù‡ Ø§Ø·Ù„Ø§Ø¹Ø§Øª ÙØ§Ú©ØªÙˆØ±
            currentInvoice = {
                id: Date.now(),
                type,
                number,
                date,
                dueDate,
                seller: {
                    name: seller,
                    taxId: sellerTaxId,
                    address: sellerAddress,
                    phone: sellerPhone
                },
                buyer: {
                    name: buyer,
                    taxId: buyerTaxId,
                    address: buyerAddress
                },
                items,
                subtotal,
                totalDiscount,
                taxRate,
                taxAmount,
                totalAmount,
                paymentTerms,
                notes,
                sellerSignature,
                createdAt: new Date().toLocaleDateString('fa-IR')
            };

            // Ù†Ù…Ø§ÛŒØ´ Ù¾ÛŒØ´â€ŒÙ†Ù…Ø§ÛŒØ´
            displayInvoicePreview(currentInvoice);
            document.getElementById('invoice-actions').style.display = 'block';
            
            showSuccessMessage('ÙØ§Ú©ØªÙˆØ± Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø§ÛŒØ¬Ø§Ø¯ Ø´Ø¯');
        }

        // Ù†Ù…Ø§ÛŒØ´ Ù¾ÛŒØ´â€ŒÙ†Ù…Ø§ÛŒØ´ ÙØ§Ú©ØªÙˆØ±
        function displayInvoicePreview(invoice) {
            const previewContainer = document.getElementById('invoice-preview');
            
            const typeNames = {
                'sale': 'ÙØ±ÙˆØ´',
                'purchase': 'Ø®Ø±ÛŒØ¯',
                'proforma': 'Ù¾ÛŒØ´â€ŒÙØ§Ú©ØªÙˆØ±',
                'return': 'Ø¨Ø±Ú¯Ø´Øª Ø§Ø² ÙØ±ÙˆØ´'
            };

            const paymentTermsNames = {
                'cash': 'Ù†Ù‚Ø¯ÛŒ',
                'check': 'Ú†Ú©',
                'installment': 'Ø§Ù‚Ø³Ø§Ø·',
                'transfer': 'Ú©Ø§Ø±Øª Ø¨Ù‡ Ú©Ø§Ø±Øª'
            };

            let itemsHtml = '';
            invoice.items.forEach((item, index) => {
                itemsHtml += `
                    <tr>
                        <td>${index + 1}</td>
                        <td style="text-align: right;">
                            <div><strong>${item.name}</strong></div>
                            ${item.description ? `<div style="font-size: 0.7em; color: #666; margin-top: 3px;">${item.description}</div>` : ''}
                        </td>
                        <td>${item.quantity.toLocaleString()}</td>
                        <td>${item.price.toLocaleString()}</td>
                        <td>${item.discount}%</td>
                        <td>${item.discountAmount.toLocaleString()}</td>
                        <td>${item.net.toLocaleString()}</td>
                    </tr>
                `;
            });

            previewContainer.innerHTML = `
                <div class="invoice-header">
                    <h2>ÙØ§Ú©ØªÙˆØ± ${typeNames[invoice.type]}</h2>
                    <p><strong>Ø´Ù…Ø§Ø±Ù‡:</strong> ${invoice.number} | <strong>ØªØ§Ø±ÛŒØ®:</strong> ${formatDate(invoice.date)}</p>
                    ${invoice.dueDate ? `<p><strong>ØªØ§Ø±ÛŒØ® Ø³Ø±Ø±Ø³ÛŒØ¯:</strong> ${formatDate(invoice.dueDate)}</p>` : ''}
                </div>

                <div class="invoice-details">
                    <div>
                        <h4>ÙØ±ÙˆØ´Ù†Ø¯Ù‡:</h4>
                        <p><strong>${invoice.seller.name}</strong></p>
                        ${invoice.seller.taxId ? `<p>Ú©Ø¯ Ø§Ù‚ØªØµØ§Ø¯ÛŒ: ${invoice.seller.taxId}</p>` : ''}
                        ${invoice.seller.address ? `<p>Ø¢Ø¯Ø±Ø³: ${invoice.seller.address}</p>` : ''}
                        ${invoice.seller.phone ? `<p>ØªÙ„ÙÙ†: ${invoice.seller.phone}</p>` : ''}
                    </div>
                    <div>
                        <h4>Ø®Ø±ÛŒØ¯Ø§Ø±:</h4>
                        <p><strong>${invoice.buyer.name}</strong></p>
                        ${invoice.buyer.taxId ? `<p>Ú©Ø¯ Ø§Ù‚ØªØµØ§Ø¯ÛŒ: ${invoice.buyer.taxId}</p>` : ''}
                        ${invoice.buyer.address ? `<p>Ø¢Ø¯Ø±Ø³: ${invoice.buyer.address}</p>` : ''}
                    </div>
                </div>

                <table class="invoice-items">
                    <thead>
                        <tr>
                            <th>Ø±Ø¯ÛŒÙ</th>
                            <th>Ø´Ø±Ø­ Ú©Ø§Ù„Ø§ / Ø®Ø¯Ù…Øª</th>
                            <th>ØªØ¹Ø¯Ø§Ø¯</th>
                            <th>Ù‚ÛŒÙ…Øª ÙˆØ§Ø­Ø¯ (ØªÙˆÙ…Ø§Ù†)</th>
                            <th>ØªØ®ÙÛŒÙ %</th>
                            <th>Ù…Ø¨Ù„Øº ØªØ®ÙÛŒÙ (ØªÙˆÙ…Ø§Ù†)</th>
                            <th>Ø¬Ù…Ø¹ (ØªÙˆÙ…Ø§Ù†)</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${itemsHtml}
                    </tbody>
                </table>

                <div class="tax-calculations">
                    <div class="tax-row">
                        <span>Ø¬Ù…Ø¹ Ú©Ù„:</span>
                        <span>${invoice.subtotal.toLocaleString()} ØªÙˆÙ…Ø§Ù†</span>
                    </div>
                    <div class="tax-row">
                        <span>ØªØ®ÙÛŒÙ:</span>
                        <span>${invoice.totalDiscount.toLocaleString()} ØªÙˆÙ…Ø§Ù†</span>
                    </div>
                    <div class="tax-row">
                        <span>Ù…Ø§Ù„ÛŒØ§Øª Ø¨Ø± Ø§Ø±Ø²Ø´ Ø§ÙØ²ÙˆØ¯Ù‡ (${invoice.taxRate}%):</span>
                        <span>${invoice.taxAmount.toLocaleString()} ØªÙˆÙ…Ø§Ù†</span>
                    </div>
                    <div class="tax-row" style="border-top: 1px solid #ddd; padding-top: 5px; font-weight: bold;">
                        <span>Ù…Ø¨Ù„Øº Ù‚Ø§Ø¨Ù„ Ù¾Ø±Ø¯Ø§Ø®Øª:</span>
                        <span>${invoice.totalAmount.toLocaleString()} ØªÙˆÙ…Ø§Ù†</span>
                    </div>
                </div>

                ${invoice.notes ? `
                    <div style="margin-top: 15px; padding: 10px; background: #f8f9fa; border-radius: 5px;">
                        <strong>ØªÙˆØ¶ÛŒØ­Ø§Øª:</strong> ${invoice.notes}
                    </div>
                ` : ''}

                <div style="margin-top: 15px;">
                    <strong>Ø´Ø±Ø§ÛŒØ· Ù¾Ø±Ø¯Ø§Ø®Øª:</strong> ${paymentTermsNames[invoice.paymentTerms]}
                </div>

                <div class="invoice-signatures">
                    <div class="signature-box">
                        <div>Ø§Ù…Ø¶Ø§ Ùˆ Ù…Ù‡Ø± ÙØ±ÙˆØ´Ù†Ø¯Ù‡</div>
                        ${invoice.sellerSignature ? 
                            `<img src="${invoice.sellerSignature}" style="max-width: 200px; max-height: 80px; margin-top: 10px; border: 1px solid #ccc;">` : 
                            '<div class="signature-line"></div>'
                        }
                    </div>
                    <div class="signature-box">
                        <div>Ø§Ù…Ø¶Ø§ Ø®Ø±ÛŒØ¯Ø§Ø±</div>
                        <div class="signature-line"></div>
                    </div>
                </div>

                <div style="text-align: center; margin-top: 20px; font-size: 0.8em; color: #666;">
                    Ø§ÛŒÙ† ÙØ§Ú©ØªÙˆØ± Ø¨Ù‡ ØµÙˆØ±Øª Ø§Ù„Ú©ØªØ±ÙˆÙ†ÛŒÚ©ÛŒ ØµØ§Ø¯Ø± Ø´Ø¯Ù‡ Ùˆ Ù†ÛŒØ§Ø² Ø¨Ù‡ Ù…Ù‡Ø± Ùˆ Ø§Ù…Ø¶Ø§ÛŒ ÙÛŒØ²ÛŒÚ©ÛŒ Ù†Ø¯Ø§Ø±Ø¯
                </div>
            `;

            previewContainer.style.display = 'block';
            
            // Ø§Ø³Ú©Ø±ÙˆÙ„ Ø¨Ù‡ Ø¨Ø®Ø´ Ù¾ÛŒØ´â€ŒÙ†Ù…Ø§ÛŒØ´
            previewContainer.scrollIntoView({ behavior: 'smooth' });
        }

        // Ø¯Ø§Ù†Ù„ÙˆØ¯ ÙØ§Ú©ØªÙˆØ± Ø¨Ù‡ ØµÙˆØ±Øª PDF
        function downloadInvoiceAsPDF() {
            if (!currentInvoice) {
                alert('Ù„Ø·ÙØ§Ù‹ Ø§Ø¨ØªØ¯Ø§ ÙØ§Ú©ØªÙˆØ± Ø±Ø§ Ø§ÛŒØ¬Ø§Ø¯ Ú©Ù†ÛŒØ¯');
                return;
            }

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            const invoiceContent = document.getElementById('invoice-preview');
            
            html2canvas(invoiceContent, { 
                scale: 2, 
                useCORS: true, 
                logging: false,
                backgroundColor: '#ffffff'
            }).then(canvas => {
                const imgData = canvas.toDataURL('image/png');
                const imgWidth = 190;
                const pageHeight = 290;
                const imgHeight = canvas.height * imgWidth / canvas.width;
                let heightLeft = imgHeight;
                let position = 10;

                doc.addImage(imgData, 'PNG', 10, position, imgWidth, imgHeight);
                heightLeft -= pageHeight;

                while (heightLeft >= 0) {
                    position = heightLeft - imgHeight;
                    doc.addPage();
                    doc.addImage(imgData, 'PNG', 10, position, imgWidth, imgHeight);
                    heightLeft -= pageHeight;
                }

                doc.save(`ÙØ§Ú©ØªÙˆØ±_${currentInvoice.number}.pdf`);
                showSuccessMessage('ÙØ§Ú©ØªÙˆØ± Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø¯Ø§Ù†Ù„ÙˆØ¯ Ø´Ø¯');
            }).catch(error => {
                console.error('Ø®Ø·Ø§ Ø¯Ø± Ø§ÛŒØ¬Ø§Ø¯ PDF:', error);
                alert('Ø®Ø·Ø§ Ø¯Ø± Ø§ÛŒØ¬Ø§Ø¯ ÙØ§ÛŒÙ„ PDF. Ù„Ø·ÙØ§Ù‹ Ø¯ÙˆØ¨Ø§Ø±Ù‡ ØªÙ„Ø§Ø´ Ú©Ù†ÛŒØ¯.');
            });
        }

        // Ú†Ø§Ù¾ ÙØ§Ú©ØªÙˆØ±
        function printInvoice() {
            const invoiceContent = document.getElementById('invoice-preview').innerHTML;
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <!DOCTYPE html>
                <html dir="rtl">
                <head>
                    <title>Ú†Ø§Ù¾ ÙØ§Ú©ØªÙˆØ± ${currentInvoice.number}</title>
                    <style>
                        body { 
                            font-family: Tahoma, Arial, sans-serif; 
                            margin: 20px;
                            color: #000;
                        }
                        .invoice-header { text-align: center; margin-bottom: 20px; }
                        .invoice-details { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
                        table { width: 100%; border-collapse: collapse; margin: 15px 0; }
                        th, td { border: 1px solid #000; padding: 8px; text-align: center; }
                        th { background-color: #f0f0f0; }
                        .tax-calculations { background: #f8f8f8; padding: 10px; margin: 10px 0; }
                        .invoice-signatures { display: flex; justify-content: space-between; margin-top: 40px; }
                        .signature-line { border-top: 1px solid #000; margin-top: 60px; }
                        @media print {
                            body { margin: 0; }
                        }
                    </style>
                </head>
                <body>
                    ${invoiceContent}
                </body>
                </html>
            `);
            printWindow.document.close();
            printWindow.print();
        }

        // Ø§Ø±Ø³Ø§Ù„ ÙØ§Ú©ØªÙˆØ± Ø§Ø² Ø·Ø±ÛŒÙ‚ Ø§ÛŒÙ…ÛŒÙ„
        function sendInvoiceByEmail() {
            const email = prompt('Ù„Ø·ÙØ§Ù‹ Ø¢Ø¯Ø±Ø³ Ø§ÛŒÙ…ÛŒÙ„ Ø¯Ø±ÛŒØ§ÙØª Ú©Ù†Ù†Ø¯Ù‡ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯:');
            if (email) {
                // Ø¯Ø± ÛŒÚ© Ø³ÛŒØ³ØªÙ… ÙˆØ§Ù‚Ø¹ÛŒØŒ Ø§ÛŒÙ†Ø¬Ø§ API Ø§ÛŒÙ…ÛŒÙ„ ÙØ±Ø§Ø®ÙˆØ§Ù†ÛŒ Ù…ÛŒâ€ŒØ´ÙˆØ¯
                showSuccessMessage(`ÙØ§Ú©ØªÙˆØ± Ø¨Ù‡ Ø¢Ø¯Ø±Ø³ ${email} Ø§Ø±Ø³Ø§Ù„ Ø®ÙˆØ§Ù‡Ø¯ Ø´Ø¯ (Ø¯Ø± Ù†Ø³Ø®Ù‡ ÙˆØ§Ù‚Ø¹ÛŒØŒ Ø§ÛŒÙ…ÛŒÙ„ Ø§Ø±Ø³Ø§Ù„ Ù…ÛŒâ€ŒØ´ÙˆØ¯)`);
            }
        }

        // Ø°Ø®ÛŒØ±Ù‡ ÙØ§Ú©ØªÙˆØ± Ø¯Ø± ØªØ§Ø±ÛŒØ®Ú†Ù‡
        function saveInvoiceToHistory() {
            if (!currentInvoice) {
                alert('Ù„Ø·ÙØ§Ù‹ Ø§Ø¨ØªØ¯Ø§ ÙØ§Ú©ØªÙˆØ± Ø±Ø§ Ø§ÛŒØ¬Ø§Ø¯ Ú©Ù†ÛŒØ¯');
                return;
            }

            const invoices = JSON.parse(localStorage.getItem('invoices')) || [];
            invoices.push(currentInvoice);
            localStorage.setItem('invoices', JSON.stringify(invoices));
            
            // Ø§ÙØ²Ø§ÛŒØ´ Ø´Ù…Ø§Ø±Ù†Ø¯Ù‡ ÙØ§Ú©ØªÙˆØ±
            invoiceCounter++;
            localStorage.setItem('invoiceCounter', invoiceCounter.toString());
            
            showSuccessMessage('ÙØ§Ú©ØªÙˆØ± Ø¯Ø± ØªØ§Ø±ÛŒØ®Ú†Ù‡ Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯');
        }

        // Ø°Ø®ÛŒØ±Ù‡ Ù‚Ø§Ù„Ø¨ ÙØ§Ú©ØªÙˆØ±
        function saveInvoiceTemplate() {
            const template = {
                seller: document.getElementById('invoice-seller').value,
                sellerTaxId: document.getElementById('seller-tax-id').value,
                sellerAddress: document.getElementById('seller-address').value,
                sellerPhone: document.getElementById('seller-phone').value,
                paymentTerms: document.getElementById('payment-terms').value
            };
            
            localStorage.setItem('invoiceTemplate', JSON.stringify(template));
            showSuccessMessage('Ù‚Ø§Ù„Ø¨ ÙØ§Ú©ØªÙˆØ± Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯');
        }

        // Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù‚Ø§Ù„Ø¨â€ŒÙ‡Ø§ÛŒ ÙØ§Ú©ØªÙˆØ±
        function loadInvoiceTemplates() {
            const template = JSON.parse(localStorage.getItem('invoiceTemplate'));
            if (template) {
                document.getElementById('invoice-seller').value = template.seller || '';
                document.getElementById('seller-tax-id').value = template.sellerTaxId || '';
                document.getElementById('seller-address').value = template.sellerAddress || '';
                document.getElementById('seller-phone').value = template.sellerPhone || '';
                document.getElementById('payment-terms').value = template.paymentTerms || 'cash';
            }
        }

        // Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† ÙØ±Ù…
        function clearInvoiceForm() {
            if (confirm('Ø¢ÛŒØ§ Ø§Ø² Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† ØªÙ…Ø§Ù… Ø§Ø·Ù„Ø§Ø¹Ø§Øª ÙØ±Ù… Ø§Ø·Ù…ÛŒÙ†Ø§Ù† Ø¯Ø§Ø±ÛŒØ¯ØŸ')) {
                document.getElementById('invoice-items').innerHTML = '';
                document.getElementById('invoice-buyer').value = '';
                document.getElementById('buyer-tax-id').value = '';
                document.getElementById('buyer-address').value = '';
                document.getElementById('invoice-notes').value = '';
                clearSellerSignature();
                
                // Ø§ÙØ²ÙˆØ¯Ù† ÛŒÚ© Ø¢ÛŒØªÙ… Ø®Ø§Ù„ÛŒ
                addInvoiceItem();
                
                showSuccessMessage('ÙØ±Ù… Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ù¾Ø§Ú© Ø´Ø¯');
            }
        }

        // ÙØ±Ù…Øª ØªØ§Ø±ÛŒØ®
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('fa-IR');
        }

        // Ù†Ù…Ø§ÛŒØ´ Ù¾ÛŒØ§Ù… Ù…ÙˆÙÙ‚ÛŒØª
        function showSuccessMessage(message) {
            const existingMessage = document.querySelector('.success-message');
            if (existingMessage) {
                existingMessage.remove();
            }
            
            const successMessage = document.createElement('div');
            successMessage.className = 'success-message';
            successMessage.textContent = message;
            
            const mainContent = document.querySelector('.main-content');
            mainContent.insertBefore(successMessage, mainContent.firstChild);
            
            setTimeout(() => {
                if (successMessage.parentElement) {
                    successMessage.remove();
                }
            }, 3000);
        }
    </script>
</body>
</html>